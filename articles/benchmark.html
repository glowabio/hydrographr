<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Function benchmarks • hydrographr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Function benchmarks">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hydrographr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/hydrographr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/benchmark.html">Function benchmarks</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_brazil.html">Case study - São Francisco drainage basin</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_cuba.html">Case study - Cuba</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_Danube.html">Case study - Danube basin</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_germany.html">Case study - Germany</a></li>
    <li><a class="dropdown-item" href="../articles/example_other_stream_networks.html">Usage of hydrographr with other stream networks</a></li>
    <li><a class="dropdown-item" href="../articles/linux_system_setup.html">Setting up the package requirements on Linux</a></li>
    <li><a class="dropdown-item" href="../articles/macos_system_setup.html">Setting up the package requirements on MacOS</a></li>
    <li><a class="dropdown-item" href="../articles/windows_system_setup.html">Setting up the package requirements on Windows</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/glowabio/hydrographr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Function benchmarks</h1>
            <h3 data-toc-skip class="subtitle">Performance of selected
<code>hydrographr</code> functions and their comparison to corresponding
<code>terra</code> workflows</h3>
                        <h4 data-toc-skip class="author"></h4>
            
            <h4 data-toc-skip class="date">2025-06-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/glowabio/hydrographr/blob/HEAD/vignettes/benchmark.Rmd" class="external-link"><code>vignettes/benchmark.Rmd</code></a></small>
      <div class="d-none name"><code>benchmark.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction-and-scope">Introduction and scope<a class="anchor" aria-label="anchor" href="#introduction-and-scope"></a>
</h2>
<p>The main focus of <code>hydrographr</code> is to process
Hydrography90m <span class="citation">(<a href="#ref-amatulli2022hydrography90m">Amatulli et al. 2022</a>)</span>
data and include them in workflows in <code>R</code>. Nevertheless,
<code>hydrographr</code> provides geospatial functions which can be
useful when working with geospatial data in general, with the goal to be
computationally and RAM usage efficient. Benchmark tests for selected
<code>hydrographr</code> functions should demonstrate the capabilities
of the <code>R</code> package. We compared the tested functions to
corresponding workflows which employ the <code>terra</code> package to
put the performance into perspective without claiming any superiority of
either one of the <code>R</code> packages over the other.</p>
<p>We focused on five common geospatial tasks that can be easily
implemented with both <code>hydrographr</code> and
<code>terra</code>:</p>
<ul>
<li>Merging multiple raster layers to one file.</li>
<li>Cropping a raster layer to a bounding box extent.</li>
<li>Cropping a raster layer to an irregular boundary of a vector
polygon.</li>
<li>Reclassifying the values of a raster layer.</li>
<li>Zonal statistics of a raster layer.</li>
</ul>
<p>All benchmark experiment tasks consisted of reading the input data,
processing the data, and writing the results back to disk (if the output
is a raster layer). For each experiment we recorded the total run-time
of the entire task using the function
<code>microbenchmark::microbenchmark</code>. The peak RAM usage was
estimated by observing the task manager (in Windows) and top (on Linux).
To ensure reliable estimates of the total run-time, we repeated each
experiment three times. <code>hydrographr</code> requires a different
implementations on Windows and Linux systems. Therefore we performed the
experiments on two systems, a Windows laptop computer (Windows 11 Pro
10.0.22621/Intel i5-8350U/16 GB RAM) and a Laptop running Ubuntu Linux
(Ubuntu 20.04.6 LTS/Intel i5-10310U/16 GB RAM) to identify any major
performance differences between operating systems. The following chapter
summarizes the results of the benchmark experiments which where
performed on the two different systems. After the results summary we
documented the code for the individual geospatial tasks for
reproducability. We implemented all <code>hydrographr</code> and
<code>terra</code> functions with default settings and we acknowledge
that specific input arguments may improve the performance. Nevertheless
the benchmark experiments provide a first general performance
overview.</p>
</div>
<div class="section level2">
<h2 id="results-of-benchmark-experiments">Results of benchmark experiments<a class="anchor" aria-label="anchor" href="#results-of-benchmark-experiments"></a>
</h2>
<p>The benchmark shows that <code><a href="../reference/merge_tiles.html">hydrographr::merge_tiles</a></code>
overall merged the six tiles faster and using less RAM compared to
<code>terra</code> where the tiles are loaded in R merged with
<code><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">terra::merge</a></code> and written to the hard drive. On average, the
performance of <code><a href="../reference/merge_tiles.html">hydrographr::merge_tiles</a></code> surpassed that of
<code>terra</code> on both Windows and Ubuntu, completing the task 2.5
times faster (179 compared to 457 seconds) and 4 times faster (158
compared to 623 seconds), respectively. Additionally, <code>terra</code>
required on Windows five times the amount of RAM to perform the merge
operation compared to <code>hydrographr</code> (0.84 compared to 4.24
GB).</p>
<p>For both tasks, cropping a raster to the extent of a bounding box and
to the boundary of a vector polygon, <code><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">terra::crop</a></code>
outperforms <code><a href="../reference/crop_to_extent.html">hydrographr::crop_to_extent</a></code> in the experiments
on the Windows system, performing the tasks 3.5 times (130 compared to
454 seconds) and 2.5 times (225 compared to 571 seconds) faster. The
differences on the Ubuntu system were less significant. Particularly, on
the Windows system, <code>terra</code> used 4.5 times (4.43 compared to
0.97 GB) and 3.4 times (3.53 compared to 1.05 GB) more RAM to perform
the cropping task.</p>
<p>The reclassification task was performed for the sub-catchments of the
entire Amazon basin, reassigning random integer values to the over 31
million sub-catchment IDs, thus requiring a rather large
reclassification table. While <code><a href="../reference/reclass_raster.html">hydrographr::reclass_raster</a></code>
was able to perform the task in 179 (Windows) and 116 seconds (Ubuntu),
respectively, while we aborted the <code><a href="https://rspatial.github.io/terra/reference/classify.html" class="external-link">terra::classify</a></code> after 12
hours of run-time with a progress of approximately 10%.</p>
<p>To assess the performance of computing zonal statistics using
<code><a href="../reference/extract_zonal_stat.html">hydrographr::extract_zonal_stat</a></code>, we implemented
<code><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">terra::zonal</a></code> to calculate the mean and the standard
deviation of a flow accumulation raster layer, where the ca. 31 million
sub-catchments of the Amazon basin were used as the zones.
<code><a href="../reference/extract_zonal_stat.html">hydrographr::extract_zonal_stat</a></code> returns the following nine
statistical measures by default in a single run: the number of cells
within each zone, minimum and maximum cell values, range, arithmetic
mean, population variance, standard deviation, coefficient of variation,
and sum (as provided by the underlying r.univar function in GRASS GIS).
Hence, if several statistical measures are of interest, the run-times of
individual <code><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">terra::zonal</a></code> executions must be added up for
comparison. The calculation of the means is 2.6 times faster when
performed with <code><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">terra::zonal</a></code> on Windows 247 compared to 645
seconds) and Ubuntu (197 compared to 520 seconds). The RAM usage is
fairly large when calculating all zonal statistics with
<code>hydrographr</code>, with 9.38 GB on Windows and 6.96 GB on Linux,
while the mean calculation with <code>terra</code> only used 2.68 and
5.39 GB, respectively. While the standard deviation is included in the
<code>hydrographr</code> output table, <code><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">terra::zonal</a></code> could
not complete the task of calculating the standard deviation and ran out
of memory.</p>
<p><img src="../reference/figures/benchmark.png"></p>
</div>
<div class="section level2">
<h2 id="benchmark-experiments">Benchmark experiments<a class="anchor" aria-label="anchor" href="#benchmark-experiments"></a>
</h2>
<div class="section level3">
<h3 id="r-packages-and-paths">R packages and paths<a class="anchor" aria-label="anchor" href="#r-packages-and-paths"></a>
</h3>
<p>Load required libraries:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glowabio.github.io/hydrographr/" class="external-link">hydrographr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span></code></pre></div>
<p>Function definitions:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Small helper function to print benchmark experiments</span></span>
<span><span class="va">print_experiment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">micro</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run times in seconds:\n"</span><span class="op">)</span></span>
<span>  <span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">micro</span><span class="op">$</span><span class="va">time</span><span class="op">*</span><span class="fl">1e-9</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"max"</span><span class="op">)</span></span>
<span>  <span class="va">t</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Define working directory:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the working directory for the benchmark experiments</span></span>
<span><span class="va">wdir</span> <span class="op">&lt;-</span> <span class="st">"my/working/directory/benchmark"</span></span>
<span></span>
<span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/data"</span><span class="op">)</span></span>
<span><span class="va">out_dir</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/output"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a new folder in the working directory to store all the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">data_dir</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">out_dir</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="loading-and-preparing-hydrography90m-test-data">Loading and preparing Hydrography90m test data<a class="anchor" aria-label="anchor" href="#loading-and-preparing-hydrography90m-test-data"></a>
</h3>
<p>We selected the Amazon river basin as a test case, which covers six
Hydrography90m tiles in total. The required tile ids which we have to
download are defined with <code>tile_id</code>. The calculation of zonal
statistics we want to perform for the flow accumulation. So we also
download the respective layer tiles from Hydrography90m (defined with
<code>vars_tif</code>). We will also load the Amazon
<code>"basin"</code> boundary vector layer and will use it in a cropping
task. To download the Hydrography90m data we can use the
<code>hydrographr</code> function <code>download_tiles</code> as shown
below.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define tile IDs</span></span>
<span><span class="va">tile_id</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"h10v06"</span>,<span class="st">"h10v08"</span>, <span class="st">"h10v10"</span>, <span class="st">"h12v06"</span>, <span class="st">"h12v08"</span>, <span class="st">"h12v10"</span><span class="op">)</span></span>
<span><span class="co"># Variables in raster format</span></span>
<span><span class="va">vars_tif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sub_catchment"</span>, <span class="st">"accumulation"</span><span class="op">)</span></span>
<span><span class="co"># Variables in vector format</span></span>
<span><span class="va">vars_gpkg</span> <span class="op">&lt;-</span> <span class="st">"basin"</span></span>
<span></span>
<span><span class="co"># Download the .tif tiles of the desired variables</span></span>
<span><span class="fu"><a href="../reference/download_tiles.html">download_tiles</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">vars_tif</span>, tile_id <span class="op">=</span> <span class="va">tile_id</span>, file_format <span class="op">=</span> <span class="st">"tif"</span>,</span>
<span>               download_dir <span class="op">=</span> <span class="va">data_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download the .gpkg tiles of the desired variables</span></span>
<span><span class="fu"><a href="../reference/download_tiles.html">download_tiles</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">vars_gpkg</span>, tile_id <span class="op">=</span> <span class="va">tile_id</span>, file_format <span class="op">=</span> <span class="st">"gpkg"</span>,</span>
<span>               download_dir <span class="op">=</span>   <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/data"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We also define the extent of the bounding box of the Amazon basin.
The bounding box will be used in a benchmark test for cropping, but also
for the preparation of the flow accumulation layer.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">79.6175000</span>, <span class="op">-</span><span class="fl">20.4991667</span>, <span class="op">-</span><span class="fl">50.3400000</span>, <span class="fl">5.2808333</span><span class="op">)</span></span></code></pre></div>
<p>For the use in the zonal statistics calculation we merge the
downloaded flow accumulation tiles with the <code>hydrographr</code>
function <code>merge_tiles</code>and crop the merged layer to the
defined bounding box with <code>crop_to_extent</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Path where the flow accumulation tiles where loaded to.</span></span>
<span><span class="va">acc_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"/r.watershed/accumulation_tiles20d/"</span><span class="op">)</span></span>
<span><span class="co"># List all flow accumulation tiles in the folder.</span></span>
<span><span class="va">acc_tifs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">acc_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge the tiles to one flow accumulation layer.</span></span>
<span><span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">acc_dir</span>,</span>
<span>            tile_names <span class="op">=</span> <span class="va">acc_tifs</span>,</span>
<span>            out_dir <span class="op">=</span> <span class="va">acc_dir</span>,</span>
<span>            file_name <span class="op">=</span> <span class="st">"acc_merge.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/crop_to_extent.html">crop_to_extent</a></span><span class="op">(</span>raster_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">acc_dir</span>, <span class="st">"acc_merge.tif"</span><span class="op">)</span>,</span>
<span>               bounding_box <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>               out_dir <span class="op">=</span> <span class="va">acc_dir</span>,</span>
<span>               file_name <span class="op">=</span>  <span class="st">"acc_merge_crop.tif"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="experiment-1-merging-tiles">Experiment 1: Merging tiles<a class="anchor" aria-label="anchor" href="#experiment-1-merging-tiles"></a>
</h3>
<p>The first benchmark experiment is to merge the 6 tiles which cover
the Amazon basin to on “.tif” file. The run time of the entire workflow
is evaluated, which includes loading and merging the input tiles and
writing the outputs back to the hard drive.</p>
<p>The tile files (<code>tile_tifs</code>) were loaded into the data
folder which we will now define as <code>tile_dir</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Folder where the sub-catchment tiles were downloaded to.</span></span>
<span><span class="va">tile_dir</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"/r.watershed/sub_catchment_tiles20d"</span><span class="op">)</span></span>
<span><span class="co"># List all tile names in tile_dir</span></span>
<span><span class="va">tile_tifs</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">tile_dir</span>, pattern <span class="op">=</span> <span class="st">".tif$"</span><span class="op">)</span></span></code></pre></div>
<p>Merging tiles with <code>hydrographr</code> is performed with the
function <code>merge_tiles</code>. The output layer is saved into
<code>out_dir</code>. The default compression level
(<code>compression</code>) is <code>"low"</code>, which results already
in relatively small output files while not compromising run time too
much.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_merge_hydr</span></span>
<span><span class="va">t_merge_hydr</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">tile_dir</span>,</span>
<span>              tile_names <span class="op">=</span> <span class="va">tile_tifs</span>,</span>
<span>              out_dir <span class="op">=</span> <span class="va">out_dir</span>,</span>
<span>              file_name <span class="op">=</span> <span class="st">"merge_hydr.tif"</span>,</span>
<span>              compression <span class="op">=</span> <span class="st">"low"</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_merge_hydr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  160.5  179.4  190.3</span></span></code></pre>
<p>The tested <code>terra</code> workflow involves reading the 6
sub-catchment tiles with the function <code>rast</code>, merging them
with <code>merge</code> and writing the result layer with
<code>writeRaster</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_merge_terra</span></span>
<span><span class="va">t_merge_terra</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r_merge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">r1</span>, <span class="va">r2</span>, <span class="va">r3</span>, <span class="va">r4</span>, <span class="va">r5</span>, <span class="va">r6</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">r_merge</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">"/merge_terra.tif"</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_merge_terra</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  454.9  457.4  457.4</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="experiment-2-cropping-to-bounding-box">Experiment 2: Cropping to bounding box<a class="anchor" aria-label="anchor" href="#experiment-2-cropping-to-bounding-box"></a>
</h3>
<p>In the following experiment the merged layer “merge_hydr.tif” is
cropped to the defined bounding box of the Amazon basin. Cropping with
<code>hydrographr</code> is performed with the function
<code>crop_to_extent</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_crop_bbox_hydr</span></span>
<span><span class="va">t_crop_bbox_hydr</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/crop_to_extent.html">crop_to_extent</a></span><span class="op">(</span>raster_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/merge_hydr.tif'</span><span class="op">)</span>,</span>
<span>                 bounding_box <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>                 out_dir <span class="op">=</span> <span class="va">out_dir</span>,</span>
<span>                 file_name <span class="op">=</span>  <span class="st">'crop_bbox_hydr.tif'</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_crop_bbox_hydr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  449.8  453.7  478.4</span></span></code></pre>
<p>The corresponding <code>terra</code> workflow includes loading the
merged layer with <code>rast</code>, cropping the layer to the defined
bounding box with <code>crop</code> and writing the cropped layer to the
hard drive with <code>writeRaster</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert the numeric extent vector to an extent</span></span>
<span><span class="va">bboxe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the benchmark test 3 times and save the run times in t_crop_bbox_terra</span></span>
<span><span class="va">t_crop_bbox_terra</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/merge_hydr.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r_crop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">bboxe</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">r_crop</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_bbox_terra.tif'</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_crop_bbox_terra</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  130.1  130.6  143.6</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="experiment-3-cropping-to-basin-boundary">Experiment 3: Cropping to basin boundary<a class="anchor" aria-label="anchor" href="#experiment-3-cropping-to-basin-boundary"></a>
</h3>
<p>Experiment 3 is generally the same as experiment 2, but instead of a
bounding box the merged layer was cropped and masked with the basin
boundary of the Amazon basin. The basin boundary layer shold be located
in the data folder.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basin_gpkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"/basin_514761/basin_514761.gpkg"</span><span class="op">)</span></span></code></pre></div>
<p>Cropping with <code>hydrographr</code> is again performed with the
function <code>crop_to_extent</code>. Instead of the
<code>bounding_box</code> the path to the ‘gpkg’ input file of the basin
boundary is passed to the function with <code>vector_layer</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_crop_vect_hydr</span></span>
<span><span class="va">t_crop_vect_hydr</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/crop_to_extent.html">crop_to_extent</a></span><span class="op">(</span>raster_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/merge_hydr.tif'</span><span class="op">)</span>,</span>
<span>                 vector_layer <span class="op">=</span> <span class="va">basin_gpkg</span>,</span>
<span>                 out_dir <span class="op">=</span> <span class="va">out_dir</span>,</span>
<span>                 file_name <span class="op">=</span>  <span class="st">'crop_vect_hydr.tif'</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_crop_vect_hydr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  568.0  571.0  592.3</span></span></code></pre>
<p>The corresponding <code>terra</code> workflow includes loading the
merged layer with <code>rast</code>, loading the basin boundary with
<code>vect</code>, cropping the layer to the basin boundary with
<code>crop</code> and writing the cropped layer to the hard drive with
<code>writeRaster</code>. For <code>crop</code> the input argument
<code>mask = TRUE</code> is set, to crop and mask the layer with the
basin boundary polygon.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_crop_vect_terra</span></span>
<span><span class="va">t_crop_vect_terra</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/merge_terra_linux.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">basin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">basin_gpkg</span><span class="op">)</span></span>
<span>  <span class="va">r_crop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">basin</span>, mask <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">r_crop</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_terra.tif'</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_crop_vect_terra</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  224.3  225.0  225.5</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="experiment-4-reclassifying-raster-values">Experiment 4: Reclassifying raster values<a class="anchor" aria-label="anchor" href="#experiment-4-reclassifying-raster-values"></a>
</h3>
<p>For the reclassification task all sub-catchment IDs of the Amazon
basin should be reassigned a new random value. To set up the experiment,
a table is generated which includes all unique sub-catchment IDs
(<code>recl_hydr$id</code>) and a corresponding “new” random integer
number between 1 and 100 (<code>recl_hydr$new</code>). The Amazon basin
has approximately 31 million sub-catchments which should be
reclassified.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span></span>
<span><span class="va">recl_hydr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">ids</span><span class="op">$</span><span class="va">crop_vect_hydr_low_linux</span>, </span>
<span>                        new <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">recl_hydr</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">recl_hydr</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">recl_hydr</span><span class="op">$</span><span class="va">new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">recl_hydr</span><span class="op">$</span><span class="va">new</span><span class="op">)</span></span></code></pre></div>
<p>The reclassification with <code>hydrographr</code> was performed with
the function <code>reclass_raster</code>. For the reclassification of
the sub-catchment IDs the generated dummy input table
<code>recl_hydr</code> was passed to the function with <code>data</code>
and the cropped and masked sub-catchment layer was used for the reclass
task.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_recl_hydr</span></span>
<span><span class="va">t_recl_hydr</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/reclass_raster.html">reclass_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">recl_hydr</span>, rast_val <span class="op">=</span> <span class="st">"id"</span>, new_val <span class="op">=</span> <span class="st">"new"</span>,</span>
<span>                 raster_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span>,</span>
<span>                 recl_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/recl_hydr.tif'</span><span class="op">)</span>,</span>
<span>                 read <span class="op">=</span> <span class="cn">FALSE</span>, no_data <span class="op">=</span> <span class="fl">0</span>, type <span class="op">=</span> <span class="st">"Int32"</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_recl_hydr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  162.4  179.5  188.0</span></span></code></pre>
<p>The corresponding <code>terra</code> workflow includes loading the
cropped sub-catchment layer with <code>rast</code>, the reclassification
with <code>classify</code> and writing the cropped layer to the hard
drive with <code>writeRaster</code>. <code>classify</code> requires a
matrix which defines the from/to values. The reclass workflow with
<code>terra</code> was aborted after 12 hours and a progress of
approximately 10% and cannot be compared to the performance of
<code>hydrographr</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ids_mtx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">recl_hydr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the benchmark test 3 times and save the run times in t_recl_terra</span></span>
<span><span class="va">t_recl_terra</span> <span class="op">&lt;-</span><span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">recl_terra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/classify.html" class="external-link">classify</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">ids_mtx</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">recl_terra</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/recl_terra.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="experiment-5-zonal-statistics">Experiment 5: Zonal statistics<a class="anchor" aria-label="anchor" href="#experiment-5-zonal-statistics"></a>
</h3>
<p>Zonal statistics were calculated based on the cropped and masked
sub-catchment layer to define the zones and the flow accumulation of the
Amazon basin for which zonal statistics were calculated.
<code>hydrographr</code> calculates zonal statistics with the function
<code>extract_zonal_stat</code>. In its current version it cannot select
specific statistical metrics which should be calculated, but returns a
table of statistics including the minimum and maximum values, the range,
the arithmetic mean, variance and standard deviation, the coefficient of
variation, and the number of cells per zone. Therefore, the run time to
calculate all of these metrics is compared to the calculation of the
arithmetic mean and the standard deviation with <code>terra</code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_zonal_hydr</span></span>
<span><span class="va">t_zonal_hydr</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/extract_zonal_stat.html">extract_zonal_stat</a></span><span class="op">(</span>data_dir<span class="op">=</span> <span class="va">acc_dir</span>,</span>
<span>                     subc_id <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>                     subc_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span>,</span>
<span>                     var_layer <span class="op">=</span> <span class="st">"acc_merge_crop.tif"</span>,</span>
<span>                     out_dir <span class="op">=</span> <span class="va">out_dir</span>,</span>
<span>                     file_name <span class="op">=</span> <span class="st">"zonal_hydr.csv"</span>,</span>
<span>                     n_cores <span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_zonal_hydr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  631.6  644.7  657.0</span></span></code></pre>
<p>In a first test workflow with <code>terra</code> the mean value of
flow accumulation for the sub-catchments is calculated. The
corresponding <code>terra</code> workflow includes loading the cropped
and masked sub-catchment layer with <code>rast</code>, loading the
cropped flow accumulation layer, calculating the mean value for all
sub-catchments with <code>zonal</code> and the input argument
<code>fun = "mean"</code> and writing the cropped layer to the hard
drive with <code>writeRaster</code>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_zonal_terra_mean</span></span>
<span><span class="va">t_zonal_terra_mean</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">acc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">acc_dir</span>, <span class="st">"/acc_merge_crop.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">zonal_terra_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">zonal</a></span><span class="op">(</span><span class="va">acc</span>, <span class="va">z</span>, fun <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_zonal_terra_mean</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  246.6  247.0  251.7</span></span></code></pre>
<p>In a second experiment with <code>terra</code> the standard deviation
should be calculated. The workflow remains the same. The only difference
is the input argument <code>fun</code> in <code>zonal</code> which is
now set as <code>fun = "sd"</code>. The execution of this experiment
resulted in a memory overflow and could not be completed.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_zonal_terra_sd</span></span>
<span><span class="va">t_zonal_terra_sd</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">acc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">acc_dir</span>, <span class="st">"/acc_merge_crop.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">zonal_terra_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">zonal</a></span><span class="op">(</span><span class="va">acc</span>, <span class="va">z</span>, fun <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3 unnumbered">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-amatulli2022hydrography90m" class="csl-entry">
Amatulli, Giuseppe, Jaime Garcia Marquez, Tushar Sethi, Jens Kiesel,
Afroditi Grigoropoulou, Maria M Üblacker, Longzhu Q Shen, and Sami
Domisch. 2022. <span>“Hydrography90m: A New High-Resolution Global
Hydrographic Dataset.”</span> <em>Earth System Science Data</em> 14
(10): 4525–50.
</div>
<div id="ref-terra" class="csl-entry">
Hijmans, Robert J. 2023. <em>Terra: Spatial Data Analysis</em>. <a href="https://CRAN.R-project.org/package=terra" class="external-link">https://CRAN.R-project.org/package=terra</a>.
</div>
<div id="ref-micro" class="csl-entry">
Mersmann, Olaf. 2023. <em>Microbenchmark: Accurate Timing
Functions</em>. <a href="https://CRAN.R-project.org/package=microbenchmark" class="external-link">https://CRAN.R-project.org/package=microbenchmark</a>.
</div>
<div id="ref-hydrographr" class="csl-entry">
Schürz, Marlene, Afroditi Grigoropoulou, Jaime Garcia Marquez, Yusdiel
Torres Cambas, Christoph Schürz, Mathieu Floury, Thomas Tomiczek,
Vanessa Bremerich, Giuseppe Amatulli, and Sami Domisch. 2023.
<em>Hydrographr: Scalable Hydrographic Data Processing in r</em>. <a href="https://glowabio.github.io/hydrographr/" class="external-link">https://glowabio.github.io/hydrographr/</a>.
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Marlene Schürz, Afroditi Grigoropoulou, Jaime Garcia Marquez, Yusdiel Torres Cambas, Christoph Schürz, Mathieu Floury, Thomas Tomiczek, Vanessa Bremerich, Merret Buurman, Giuseppe Amatulli, Sami Domisch.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
