<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="hydrographr">
<title>Function benchmarks • hydrographr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Function benchmarks">
<meta property="og:description" content="hydrographr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hydrographr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.14</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/hydrographr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/benchmark.html">Function benchmarks</a>
    <a class="dropdown-item" href="../articles/case_study_brazil.html">Case study - São Francisco drainage basin</a>
    <a class="dropdown-item" href="../articles/case_study_cuba.html">Case study - Cuba</a>
    <a class="dropdown-item" href="../articles/linux_system_setup.html">Setting up the package requirements on Linux</a>
    <a class="dropdown-item" href="../articles/windows_system_setup.html">Setting up the package requirements on Windows</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/glowabio/hydrographr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Function benchmarks</h1>
            <h3 data-toc-skip class="subtitle">Performance of selected
<code>hydrographr</code> functions and their comparison to corresponding
<code>terra</code> workflows</h3>
                        <h4 data-toc-skip class="author"></h4>
            
            <h4 data-toc-skip class="date">2023-05-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/glowabio/hydrographr/blob/HEAD/vignettes/benchmark.Rmd" class="external-link"><code>vignettes/benchmark.Rmd</code></a></small>
      <div class="d-none name"><code>benchmark.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="introduction-and-scope">Introduction and scope<a class="anchor" aria-label="anchor" href="#introduction-and-scope"></a>
</h3>
<p>The main focus of <code>hydrographr</code> is to process
Hydrography90m <span class="citation">(<a href="#ref-amatulli2022hydrography90m" role="doc-biblioref">Amatulli et
al. 2022</a>)</span> data and include them in workflows in
<code>R</code>. Nevertheless, <code>hydrographr</code> provides
geospatial functions which can be useful when working with geospatial
data in general, with the goal to be computationally and RAM usage
efficient. Benchmark tests for selected <code>hydrographr</code>
functions should demonstrate the capabilities of the <code>R</code>
package. We compared the tested functions to corresponding workflows
which employ the <code>terra</code> package to put the performance into
perspective without claiming any superiority of either one of the
<code>R</code> packages over the other.</p>
<p>We focused on five common geospatial tasks that can be easily
implemented with both <code>hydrographr</code> and
<code>terra</code>:</p>
<ul>
<li>Merging multiple raster layers to one file.</li>
<li>Cropping a raster layer to a bounding box extent.</li>
<li>Cropping a raster layer to an irregular boundary of a vector
polygon.</li>
<li>Reclassifying the values of a raster layer.</li>
<li>Zonal statistics of a raster layer.</li>
</ul>
<p>All benchmark experiment tasks consisted of reading the input data,
processing the data, and writing the results back to disk (if the output
is a raster layer). For each experiment, we recorded the total run-time
of the entire task using the function
<code><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark::microbenchmark</a></code>. The peak RAM usage was
estimated by observing the task manager (in Windows) and top (on Linux).
To ensure reliable estimates of the total run-time, we repeated each
experiment three times. <code>hydrographr</code> requires a different
implementations on Windows and Linux systems. Therefore we performed the
experiments on two systems, a Windows laptop computer (Windows 11 Pro
10.0.22621/Intel i5-8350U/16 GB RAM) and a Laptop running Ubuntu Linux
(Ubuntu 20.04.6 LTS/Intel i5-10310U/16 GB RAM) to identify any major
performance differences between operating systems. The code for the
individual geospatial tasks which was executed on both platforms is
documented below for reproducability. We implemented all
<code>hydrographr</code> and <code>terra</code> functions with default
settings and we acknowledge that specific input arguments may improve
the performance. Nevertheless the benchmark experiments provide a first
general performance overview.</p>
</div>
<div class="section level3">
<h3 id="r-packages-and-paths">R packages and paths<a class="anchor" aria-label="anchor" href="#r-packages-and-paths"></a>
</h3>
<p>Load required libraries:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glowabio.github.io/hydrographr/" class="external-link">hydrographr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span></code></pre></div>
<p>Function definitions:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Small helper function to print benchmark experiments</span></span>
<span><span class="va">print_experiment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">micro</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run times in seconds:\n"</span><span class="op">)</span></span>
<span>  <span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">micro</span><span class="op">$</span><span class="va">time</span><span class="op">*</span><span class="fl">1e-9</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"max"</span><span class="op">)</span></span>
<span>  <span class="va">t</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Define working directory:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the working directory for the benchmark experiments</span></span>
<span><span class="va">wdir</span> <span class="op">&lt;-</span> <span class="st">"my/working/directory/benchmark"</span></span>
<span></span>
<span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/data"</span><span class="op">)</span></span>
<span><span class="va">out_dir</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/output"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a new folder in the working directory to store all the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">data_dir</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">out_dir</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="loading-and-preparing-hydrography90m-test-data">Loading and preparing Hydrography90m test data<a class="anchor" aria-label="anchor" href="#loading-and-preparing-hydrography90m-test-data"></a>
</h3>
<p>We selected the Amazon river basin as a test case, which covers six
Hydrography90m tiles in total. The required tile ids which we have to
download are defined with <code>tile_id</code>. The calculation of zonal
statistics we want to perform for the flow accumulation. So we also
download the respective layer tiles from Hydrography90m (defined with
<code>vars_tif</code>). We will also load the Amazon
<code>"basin"</code> boundary vector layer and will use it in a cropping
task. To download the Hydrography90m data we can use the
<code>hydrographr</code> function <code>download_tiles</code> as shown
below.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define tile IDs</span></span>
<span><span class="va">tile_id</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"h10v06"</span>,<span class="st">"h10v08"</span>, <span class="st">"h10v10"</span>, <span class="st">"h12v06"</span>, <span class="st">"h12v08"</span>, <span class="st">"h12v10"</span><span class="op">)</span></span>
<span><span class="co"># Variables in raster format</span></span>
<span><span class="va">vars_tif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sub_catchment"</span>, <span class="st">"accumulation"</span><span class="op">)</span></span>
<span><span class="co"># Variables in vector format</span></span>
<span><span class="va">vars_gpkg</span> <span class="op">&lt;-</span> <span class="st">"basin"</span></span>
<span></span>
<span><span class="co"># Download the .tif tiles of the desired variables</span></span>
<span><span class="fu"><a href="../reference/download_tiles.html">download_tiles</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">vars_tif</span>, tile_id <span class="op">=</span> <span class="va">tile_id</span>, file_format <span class="op">=</span> <span class="st">"tif"</span>,</span>
<span>               download_dir <span class="op">=</span> <span class="va">data_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download the .gpkg tiles of the desired variables</span></span>
<span><span class="fu"><a href="../reference/download_tiles.html">download_tiles</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">vars_gpkg</span>, tile_id <span class="op">=</span> <span class="va">tile_id</span>, file_format <span class="op">=</span> <span class="st">"gpkg"</span>,</span>
<span>               download_dir <span class="op">=</span>   <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/data"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We also define the extent of the bounding box of the Amazon basin.
The bounding box will be used in a benchmark test for cropping, but also
for the preparation of the flow accumulation layer.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">79.6175000</span>, <span class="op">-</span><span class="fl">20.4991667</span>, <span class="op">-</span><span class="fl">50.3400000</span>, <span class="fl">5.2808333</span><span class="op">)</span></span></code></pre></div>
<p>For the use in the zonal statistics calculation we merge the
downloaded flow accumulation tiles with the <code>hydrographr</code>
function <code>merge_tiles</code>and crop the merged layer to the
defined bounding box with <code>crop_to_extent</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Path where the flow accumulation tiles where loaded to.</span></span>
<span><span class="va">acc_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"/r.watershed/accumulation_tiles20d/"</span><span class="op">)</span></span>
<span><span class="co"># List all flow accumulation tiles in the folder.</span></span>
<span><span class="va">acc_tifs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">acc_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge the tiles to one flow accumulation layer.</span></span>
<span><span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">acc_dir</span>,</span>
<span>            tile_names <span class="op">=</span> <span class="va">acc_tifs</span>,</span>
<span>            out_dir <span class="op">=</span> <span class="va">acc_dir</span>,</span>
<span>            file_name <span class="op">=</span> <span class="st">"acc_merge.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/crop_to_extent.html">crop_to_extent</a></span><span class="op">(</span>raster_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">acc_dir</span>, <span class="st">"acc_merge.tif"</span><span class="op">)</span>,</span>
<span>               bounding_box <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>               out_dir <span class="op">=</span> <span class="va">acc_dir</span>,</span>
<span>               file_name <span class="op">=</span>  <span class="st">"acc_merge_crop.tif"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="experiment-1-merging-tiles">Experiment 1: Merging tiles<a class="anchor" aria-label="anchor" href="#experiment-1-merging-tiles"></a>
</h3>
<p>The first benchmark experiment is to merge the 6 tiles which cover
the Amazon basin to on “.tif” file. The run time of the entire workflow
is evaluated, which includes loading and merging the input tiles and
writing the outputs back to the hard drive.</p>
<p>The tile files (<code>tile_tifs</code>) were loaded into the data
folder which we will now define as <code>tile_dir</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Folder where the sub-catchment tiles were downloaded to.</span></span>
<span><span class="va">tile_dir</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"/r.watershed/sub_catchment_tiles20d"</span><span class="op">)</span></span>
<span><span class="co"># List all tile names in tile_dir</span></span>
<span><span class="va">tile_tifs</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">tile_dir</span>, pattern <span class="op">=</span> <span class="st">".tif$"</span><span class="op">)</span></span></code></pre></div>
<p>Merging tiles with <code>hydrographr</code> is performed with the
function <code>merge_tiles</code>. The output layer is saved into
<code>out_dir</code>. The default compression level
(<code>compression</code>) is <code>"low"</code>, which results already
in relatively small output files while not compromising run time too
much.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_merge_hydr</span></span>
<span><span class="va">t_merge_hydr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">tile_dir</span>,</span>
<span>              tile_names <span class="op">=</span> <span class="va">tile_tifs</span>,</span>
<span>              out_dir <span class="op">=</span> <span class="va">out_dir</span>,</span>
<span>              file_name <span class="op">=</span> <span class="st">"merge_hydr.tif"</span>,</span>
<span>              compression <span class="op">=</span> <span class="st">"low"</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_merge_hydr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  160.8  164.7  197.7</span></span></code></pre>
<p>The tested <code>terra</code> workflow involves reading the 6
sub-catchment tiles with the function <code>rast</code>, merging them
with <code>merge</code> and writing the result layer with
<code>writeRaster</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_merge_terra</span></span>
<span><span class="va">t_merge_terra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tile_dir</span>, <span class="st">"/"</span>, <span class="va">tile_tifs</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r_merge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">r1</span>, <span class="va">r2</span>, <span class="va">r3</span>, <span class="va">r4</span>, <span class="va">r5</span>, <span class="va">r6</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">r_merge</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">"/merge_terra.tif"</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_merge_terra</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  524.7  524.7  525.2</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="experiment-2-cropping-to-bounding-box">Experiment 2: Cropping to bounding box<a class="anchor" aria-label="anchor" href="#experiment-2-cropping-to-bounding-box"></a>
</h3>
<p>In the following experiment the merged layer “merge_hydr.tif” is
cropped to the defined bounding box of the Amazon basin. Cropping with
<code>hydrographr</code> is performed with the function
<code>crop_to_extent</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_crop_bbox_hydr</span></span>
<span><span class="va">t_crop_bbox_hydr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/crop_to_extent.html">crop_to_extent</a></span><span class="op">(</span>raster_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/merge_hydr.tif'</span><span class="op">)</span>,</span>
<span>                 bounding_box <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>                 out_dir <span class="op">=</span> <span class="va">out_dir</span>,</span>
<span>                 file_name <span class="op">=</span>  <span class="st">'crop_bbox_hydr.tif'</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_crop_bbox_hydr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  428.9  430.0  430.3</span></span></code></pre>
<p>The corresponding <code>terra</code> workflow includes loading the
merged layer with <code>rast</code>, cropping the layer to the defined
bounding box with <code>crop</code> and writing the cropped layer to the
hard drive with <code>writeRaster</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert the numeric extent vector to an extent</span></span>
<span><span class="va">bboxe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the benchmark test 3 times and save the run times in t_crop_bbox_terra</span></span>
<span><span class="va">t_crop_bbox_terra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/merge_hydr.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r_crop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">bboxe</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">r_crop</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_bbox_terra.tif'</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_crop_bbox_terra</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  261.3  261.3  265.9</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="experiment-3-cropping-to-basin-boundary">Experiment 3: Cropping to basin boundary<a class="anchor" aria-label="anchor" href="#experiment-3-cropping-to-basin-boundary"></a>
</h3>
<p>Experiment 3 is generally the same as experiment 2, but instead of a
bounding box the merged layer was cropped and masked with the basin
boundary of the Amazon basin. The basin boundary layer shold be located
in the data folder.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basin_gpkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"/basin_514761/basin_514761.gpkg"</span><span class="op">)</span></span></code></pre></div>
<p>Cropping with <code>hydrographr</code> is again performed with the
function <code>crop_to_extent</code>. Instead of the
<code>bounding_box</code> the path to the ‘gpkg’ input file of the basin
boundary is passed to the function with <code>vector_layer</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_crop_vect_hydr</span></span>
<span><span class="va">t_crop_vect_hydr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/crop_to_extent.html">crop_to_extent</a></span><span class="op">(</span>raster_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/merge_hydr.tif'</span><span class="op">)</span>,</span>
<span>                 vector_layer <span class="op">=</span> <span class="va">basin_gpkg</span>,</span>
<span>                 out_dir <span class="op">=</span> <span class="va">out_dir</span>,</span>
<span>                 file_name <span class="op">=</span>  <span class="st">'crop_vect_hydr.tif'</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_crop_vect_hydr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  539.4  549.4  555.9</span></span></code></pre>
<p>The corresponding <code>terra</code> workflow includes loading the
merged layer with <code>rast</code>, loading the basin boundary with
<code>vect</code>, cropping the layer to the basin boundary with
<code>crop</code> and writing the cropped layer to the hard drive with
<code>writeRaster</code>. For <code>crop</code> the input argument
<code>mask = TRUE</code> is set, to crop and mask the layer with the
basin boundary polygon.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_crop_vect_terra</span></span>
<span><span class="va">t_crop_vect_terra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/merge_terra_linux.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">basin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">basin_gpkg</span><span class="op">)</span></span>
<span>  <span class="va">r_crop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">basin</span>, mask <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">r_crop</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_terra.tif'</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_crop_vect_terra</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  257.6  257.6  258.5</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="experiment-4-reclassifying-raster-values">Experiment 4: Reclassifying raster values<a class="anchor" aria-label="anchor" href="#experiment-4-reclassifying-raster-values"></a>
</h3>
<p>For the reclassification task all sub-catchment IDs of the Amazon
basin should be reassigned a new random value. To set up the experiment,
a table is generated which includes all unique sub-catchment IDs
(<code>recl_hydr$id</code>) and a corresponding “new” random integer
number between 1 and 100 (<code>recl_hydr$new</code>). The Amazon basin
has approximately 31 million sub-catchments which should be
reclassified.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span></span>
<span><span class="va">recl_hydr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">ids</span><span class="op">$</span><span class="va">crop_vect_hydr_low_linux</span>, </span>
<span>                        new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">recl_hydr</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">recl_hydr</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">recl_hydr</span><span class="op">$</span><span class="va">new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">recl_hydr</span><span class="op">$</span><span class="va">new</span><span class="op">)</span></span></code></pre></div>
<p>The reclassification with <code>hydrographr</code> was performed with
the function <code>reclass_raster</code>. For the reclassification of
the sub-catchment IDs the generated dummy input table
<code>recl_hydr</code> was passed to the function with <code>data</code>
and the cropped and masked sub-catchment layer was used for the reclass
task.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_recl_hydr</span></span>
<span><span class="va">t_recl_hydr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/reclass_raster.html">reclass_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">recl_hydr</span>, rast_val <span class="op">=</span> <span class="st">"id"</span>, new_val <span class="op">=</span> <span class="st">"new"</span>,</span>
<span>                 raster_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span>,</span>
<span>                 recl_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/recl_hydr.tif'</span><span class="op">)</span>,</span>
<span>                 read <span class="op">=</span> <span class="cn">FALSE</span>, no_data <span class="op">=</span> <span class="fl">0</span>, type <span class="op">=</span> <span class="st">"Int32"</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_recl_hydr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  171.0  178.0  184.3</span></span></code></pre>
<p>The corresponding <code>terra</code> workflow includes loading the
cropped sub-catchment layer with <code>rast</code>, the reclassification
with <code>classify</code> and writing the cropped layer to the hard
drive with <code>writeRaster</code>. <code>classify</code> requires a
matrix which defines the from/to values. The reclass workflow with
<code>terra</code> was aborted after 12 hours and a progress of
approximately 10% and cannot be compared to the performance of
<code>hydrographr</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ids_mtx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">recl_hydr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the benchmark test 3 times and save the run times in t_recl_terra</span></span>
<span><span class="va">t_recl_terra</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">recl_terra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/classify.html" class="external-link">classify</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">ids_mtx</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">recl_terra</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/recl_terra.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="experiment-5-zonal-statistics">Experiment 5: Zonal statistics<a class="anchor" aria-label="anchor" href="#experiment-5-zonal-statistics"></a>
</h3>
<p>Zonal statistics were calculated based on the cropped and masked
sub-catchment layer to define the zones and the flow accumulation of the
Amazon basin for which zonal statistics were calculated.
<code>hydrographr</code> calculates zonal statistics with the function
<code>extract_zonal_stat</code>. In its current version it cannot select
specific statistical metrics which should be calculated, but returns a
table of statistics including the minimum and maximum values, the range,
the arithmetic mean, variance and standard deviation, the coefficient of
variation, and the number of cells per zone. Therefore, the run time to
calculate all of these metrics is compared to the calculation of the
arithmetic mean and the standard deviation with <code>terra</code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_zonal_hydr</span></span>
<span><span class="va">t_zonal_hydr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/extract_zonal_stat.html">extract_zonal_stat</a></span><span class="op">(</span>data_dir<span class="op">=</span> <span class="va">acc_dir</span>,</span>
<span>                     subc_id <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>                     subc_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span>,</span>
<span>                     var_layer <span class="op">=</span> <span class="st">"acc_merge_crop.tif"</span>,</span>
<span>                     out_dir <span class="op">=</span> <span class="va">out_dir</span>,</span>
<span>                     file_name <span class="op">=</span> <span class="st">"zonal_hydr.csv"</span>,</span>
<span>                     n_cores <span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_zonal_hydr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  584.7  585.7  592.4</span></span></code></pre>
<p>In a first test workflow with <code>terra</code> the mean value of
flow accumulation for the sub-catchments is calculated. The
corresponding <code>terra</code> workflow includes loading the cropped
and masked sub-catchment layer with <code>rast</code>, loading the
cropped flow accumulation layer, calculating the mean value for all
sub-catchments with <code>zonal</code> and the input argument
<code>fun = "mean"</code> and writing the cropped layer to the hard
drive with <code>writeRaster</code>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_zonal_terra_mean</span></span>
<span><span class="va">t_zonal_terra_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">acc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">acc_dir</span>, <span class="st">"/acc_merge_crop.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">zonal_terra_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/zonal.html" class="external-link">zonal</a></span><span class="op">(</span><span class="va">acc</span>, <span class="va">z</span>, fun <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the run times</span></span>
<span><span class="fu">print_experiment</span><span class="op">(</span><span class="va">t_zonal_terra_mean</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Run times in seconds:</span></span>
<span><span class="co">##    min median    max </span></span>
<span><span class="co">##  246.6  247.0  251.7</span></span></code></pre>
<p>In a second experiment with <code>terra</code> the standard deviation
should be calculated. The workflow remains the same. The only difference
is the input argument <code>fun</code> in <code>zonal</code> which is
now set as <code>fun = "sd"</code>. The execution of this experiment
resulted in a memory overflow and could not be completed.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the benchmark test 3 times and save the run times in t_zonal_terra_sd</span></span>
<span><span class="va">t_zonal_terra_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">'/crop_vect_hydr.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">acc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">acc_dir</span>, <span class="st">"/acc_merge_crop.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">zonal_terra_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/zonal.html" class="external-link">zonal</a></span><span class="op">(</span><span class="va">acc</span>, <span class="va">z</span>, fun <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span></span>
<span><span class="op">}</span>, times <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3 unnumbered">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-amatulli2022hydrography90m" class="csl-entry">
Amatulli, Giuseppe, Jaime Garcia Marquez, Tushar Sethi, Jens Kiesel,
Afroditi Grigoropoulou, Maria M Üblacker, Longzhu Q Shen, and Sami
Domisch. 2022. <span>“Hydrography90m: A New High-Resolution Global
Hydrographic Dataset.”</span> <em>Earth System Science Data</em> 14
(10): 4525–50.
</div>
<div id="ref-terra" class="csl-entry">
Hijmans, Robert J. 2023. <em>Terra: Spatial Data Analysis</em>. <a href="https://CRAN.R-project.org/package=terra" class="external-link">https://CRAN.R-project.org/package=terra</a>.
</div>
<div id="ref-micro" class="csl-entry">
Mersmann, Olaf. 2023. <em>Microbenchmark: Accurate Timing
Functions</em>. <a href="https://CRAN.R-project.org/package=microbenchmark" class="external-link">https://CRAN.R-project.org/package=microbenchmark</a>.
</div>
<div id="ref-hydrographr" class="csl-entry">
Üblacker, Maria, Afroditi Grigoropoulou, Jaime Garcia Marquez, Yusdiel
Torres Cambas, Christoph Schürz, Mathieu Floury, Thomas Tomiczek,
Vanessa Bremerich, Giuseppe Amatulli, and Sami Domisch. 2023.
<em>Hydrographr: Scalable Hydrographic Data Processing in r</em>. <a href="https://glowabio.github.io/hydrographr/" class="external-link">https://glowabio.github.io/hydrographr/</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Maria Üblacker, Afroditi Grigoropoulou, Jaime Garcia Marquez, Yusdiel Torres Cambas, Christoph Schürz, Mathieu Floury, Thomas Tomiczek, Vanessa Bremerich, Giuseppe Amatulli, Sami Domisch.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
