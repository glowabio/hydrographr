<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Case study - Danube basin • hydrographr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Case study - Danube basin">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hydrographr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/hydrographr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/benchmark.html">Function benchmarks</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_brazil.html">Case study - São Francisco drainage basin</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_cuba.html">Case study - Cuba</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_Danube.html">Case study - Danube basin</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_germany.html">Case study - Germany</a></li>
    <li><a class="dropdown-item" href="../articles/example_other_stream_networks.html">Usage of hydrographr with other stream networks</a></li>
    <li><a class="dropdown-item" href="../articles/linux_system_setup.html">Setting up the package requirements on Linux</a></li>
    <li><a class="dropdown-item" href="../articles/macos_system_setup.html">Setting up the package requirements on MacOS</a></li>
    <li><a class="dropdown-item" href="../articles/windows_system_setup.html">Setting up the package requirements on Windows</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/glowabio/hydrographr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Case study - Danube basin</h1>
            <h3 data-toc-skip class="subtitle">Retrieving and processing
the Environment90m dataset for Species Distribution Modelling</h3>
                        <h4 data-toc-skip class="author"></h4>
            
            <h4 data-toc-skip class="date">2025-07-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/glowabio/hydrographr/blob/HEAD/vignettes/case_study_Danube.Rmd" class="external-link"><code>vignettes/case_study_Danube.Rmd</code></a></small>
      <div class="d-none name"><code>case_study_Danube.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The following workflow uses the new functionalities of the
hydrographr R package to download and process the Hydrography90m <span class="citation">(<a href="#ref-amatulli2022hydrography90m">Amatulli et
al., 2022</a>)</span> and the Environment90m <span class="citation">(<a href="#ref-garcia2025environment90m">García Márquez et al.,
2025</a>)</span> datasets with the aim of preparing and processing the
data needed to run a species distribution model to predict the habitat
suitability of a fish species in the Danube basin.</p>
<div class="figure" style="text-align: center">
<img src="../reference/figures/danube_workflow3.png" alt="Figure 1. Schematic workflow" width="200%"><p class="caption">
Figure 1. Schematic workflow
</p>
</div>
<p>The Environment90m dataset consists of tables with summary
information of several environmental factors, for each of the 7 million
sub-catchments available in the Hydrography90m dataset. In comparison to
the previous version of hydrographr, where the user needed to download
raster files and run the calculations of the summary statistics for the
environmental layers of interest, the new functions allow the user to
directly download the environmental data that has been already
summarised for each sub-catchment.</p>
<p>The study area is the Danube basin but we will be using a bounding
box around the basin as a geographic reference to subset and crop the
data and finally project the current habitat suitability of a species.
Given the extent of the Danube Basin and the resolution of the data, we
will be dealing with large amounts of data and therefore we need to be
sure to have enough disk space (at least 15 GB). We selected this case
on purpose to present the efficiency of the new functionalities when
analyzing large datasets.</p>
<p>We will use the species <em>Zingel treber</em> as an example. We used
the same bounding box to retrieve occurrence records of the species from
GBIF.</p>
</div>
<div class="section level2">
<h2 id="setting-the-scene">Setting the scene<a class="anchor" aria-label="anchor" href="#setting-the-scene"></a>
</h2>
<p>Load all libraries required for the analysis:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glowabio.github.io/hydrographr/" class="external-link">hydrographr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">tools</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://imbs-hl.github.io/ranger/" class="external-link">ranger</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/" class="external-link">kableExtra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/leaflet/" class="external-link">leaflet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/leafem" class="external-link">leafem</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ramnathv/htmlwidgets" class="external-link">htmlwidgets</a></span><span class="op">)</span></span></code></pre></div>
<p>Create and define a directory (e.g. data_danube) as your working
directory. We will store and organize all the data in this folder.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set working directory and global options</span></span>
<span><span class="va">wdir</span> <span class="op">&lt;-</span> <span class="st">"my/working/directory/data_danube"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">wdir</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>scipen <span class="op">=</span> <span class="fl">999</span><span class="op">)</span></span></code></pre></div>
<p>Let’s download some data we have prepared beforehand, including the
polygon of the Danube basin and the table with species occurrences.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_test_data.html">download_test_data</a></span><span class="op">(</span>download_dir <span class="op">=</span> <span class="st">"data_danube"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="area-of-interest">Area of interest<a class="anchor" aria-label="anchor" href="#area-of-interest"></a>
</h2>
<p>The area of interest is the Danube basin (Figure 2). We will use as a
reference the polygon of the basin that we downloaded previously. We
will also specify a set coordinates to define a bounding box around the
basin (see table below and red rectangle in Figure 2). This bounding box
will be useful as a reference for visualization purposes and to restrict
the spatial extent and information requirements of the analysis.</p>
<p>Corner Coordinates (WGS84, EPSG:4326):</p>
<div class="line-block">Upper Left | 8.0 | 51.0 |</div>
<div class="line-block">Lower Left | 8.0 | 42.0 |</div>
<div class="line-block">Upper Right | 30.0 | 51.0 |</div>
<div class="line-block">Lower Right | 30.0 | 42.0 |</div>
<p>Create a bounding box object with the coordinates</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">42</span>, <span class="fl">30</span>, <span class="fl">51</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"hydrography90m_test_data/hydrographr_data/DanubeMSK.gpkg"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bbcor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">dan</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># tile_id &lt;- get_tile_id(data = bbcor, lon = "X", lat = "Y")</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="../reference/figures/tilesDanube.png" alt="Figure 2. Tiles overlapping with the Danube basin" width="80%"><p class="caption">
Figure 2. Tiles overlapping with the Danube basin
</p>
</div>
<!-- ![Figure 1. Tiles overlapping with the Danube basin](../man/figures/tilesDanube.png) -->
</div>
<div class="section level2">
<h2 id="sub-catchments-in-the-danube-basin">Sub-catchments in the Danube basin<a class="anchor" aria-label="anchor" href="#sub-catchments-in-the-danube-basin"></a>
</h2>
<p>The units of analysis for this exercise are the single
sub-catchments, meaning that the final habitat suitability values will
be assigned to each of the sub-catchments. Therefore, one of the key
layers for the analysis is the raster of sub-catchments for the study
area.</p>
<p>Here are the steps to prepare the sub-catchment raster file for the
Danube basin:</p>
<ol style="list-style-type: decimal">
<li>identify the rectangular tiles that overlap with the Danube basin.
By looking at Figure 2, we see that the study area overlaps with four
tiles</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tile_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"h18v02"</span>, <span class="st">"h18v04"</span>, <span class="st">"h20v02"</span>, <span class="st">"h20v04"</span><span class="op">)</span></span>
<span><span class="va">tile_id</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>download the raster files of sub-catchments for the four tiles</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_tiles.html">download_tiles</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sub_catchment"</span><span class="op">)</span>, tile_id <span class="op">=</span> <span class="va">tile_id</span>, file_format <span class="op">=</span> <span class="st">"tif"</span>,</span>
<span>              download_dir <span class="op">=</span> <span class="va">wdir</span><span class="op">)</span></span></code></pre></div>
<p>Note that the files have been downloaded to a new folder (i.e.,
“r.watershed”). Each file covers the full extent of the corresponding
tile, which is often larger than the Danube basin. Before merging the
tiles, in order to avoid working with unnecessary data, we</p>
<ol start="3" style="list-style-type: decimal">
<li>crop the files to the extent of the Danube basin. We will use the
function ‘crop_to_extent’ and the polygon vector file of the Danube
basin as a cutline. We can apply the cropping to all files in a for
loop:</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raster_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"r.watershed"</span>, <span class="st">"sub_catchment_tiles20d"</span><span class="op">)</span>, </span>
<span>                           pattern <span class="op">=</span> <span class="st">".tif$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ifile</span> <span class="kw">in</span> <span class="va">raster_files</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/crop_to_extent.html">crop_to_extent</a></span><span class="op">(</span></span>
<span>    <span class="va">ifile</span>,</span>
<span>    vector_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"hydrography90m_test_data/hydrographr_data/DanubeMSK.gpkg"</span><span class="op">)</span>,</span>
<span>    out_dir <span class="op">=</span> <span class="va">wdir</span>,</span>
<span>    file_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">ifile</span><span class="op">)</span>, <span class="st">".tif"</span><span class="op">)</span>, <span class="st">"_crop.tif"</span><span class="op">)</span>,</span>
<span>    read <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>now we can merge the four cropped files to obtain the sub-catchment
raster file for the Danube basin</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">wdir</span>,</span>
<span>              tile_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">wdir</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                      pattern <span class="op">=</span> <span class="st">"_crop.tif"</span><span class="op">)</span>,</span>
<span>              out_dir <span class="op">=</span> <span class="va">wdir</span>,</span>
<span>              file_name <span class="op">=</span> <span class="st">"subcatchments.tif"</span>,</span>
<span>              read <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>              bigtiff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>It is always good practice to clean disk space by removing the files
and folders we don’t need anymore.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># remove files</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">wdir</span>, pattern <span class="op">=</span> <span class="st">"_crop.tif"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># remove folder</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="st">"r.watershed"</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Using the sub-catchment raster file for the Danube basin we will
create a new file containing a list with all sub-catchments IDs. This
list of IDs will be our reference file to extract the information from
the environmental tables during the next steps. We will create the file
using the function <em>extract_ids</em>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">subc_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_ids.html">extract_ids</a></span><span class="op">(</span>subc_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"subcatchments.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">subc_ids</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">subc_ids</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save the object to a file</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fwrite.html" class="external-link">fwrite</a></span><span class="op">(</span><span class="va">subc_ids</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"subc_ids.txt"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>As you can see, the file consists of one column with all the
sub-catchment IDs. In the Danube basin there are around 4,3 million
sub-catchments!</p>
</div>
<div class="section level2">
<h2 id="environmental-information">Environmental information<a class="anchor" aria-label="anchor" href="#environmental-information"></a>
</h2>
<p>Now we proceed to download the tables of the Environment90m dataset
with the environmental layers of interest. Note that we have developed
downloading functions for each of the different datasets available.</p>
<p>You can check the variable names of each dataset by calling the
function without arguments. For example, if you want to check which
climatic variables are available you can use:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_env90m_tables.html">download_observed_climate_tables</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Downloading  env90m_observedclimate_paths_file_sizes.txt ...</span></span></code></pre>
<pre><code><span><span class="co">## To download, please specify parameter 'tile_ids', and add 'download=TRUE'.</span></span></code></pre>
<pre><code><span><span class="co">## $comment</span></span>
<span><span class="co">## [1] "All available variables for this dataset."</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $dataset_name</span></span>
<span><span class="co">## [1] "chelsa_bioclim_v2_1"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $variable_names</span></span>
<span><span class="co">##  [1] "bio01_1981-2010_observed" "bio02_1981-2010_observed"</span></span>
<span><span class="co">##  [3] "bio03_1981-2010_observed" "bio04_1981-2010_observed"</span></span>
<span><span class="co">##  [5] "bio05_1981-2010_observed" "bio06_1981-2010_observed"</span></span>
<span><span class="co">##  [7] "bio07_1981-2010_observed" "bio08_1981-2010_observed"</span></span>
<span><span class="co">##  [9] "bio09_1981-2010_observed" "bio10_1981-2010_observed"</span></span>
<span><span class="co">## [11] "bio11_1981-2010_observed" "bio12_1981-2010_observed"</span></span>
<span><span class="co">## [13] "bio13_1981-2010_observed" "bio14_1981-2010_observed"</span></span>
<span><span class="co">## [15] "bio15_1981-2010_observed" "bio16_1981-2010_observed"</span></span>
<span><span class="co">## [17] "bio17_1981-2010_observed" "bio18_1981-2010_observed"</span></span>
<span><span class="co">## [19] "bio19_1981-2010_observed"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $note</span></span>
<span><span class="co">## [1] "To download, please specify parameter 'tile_ids', and add 'download=TRUE'."</span></span></code></pre>
<p>We will download few variables related to climate, the land cover,
and few morphometric variables describing the properties of the stream
segments.</p>
<ul>
<li>Observed climate:</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_env90m_tables.html">download_observed_climate_tables</a></span><span class="op">(</span></span>
<span>  subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bio01_1981-2010_observed"</span>, <span class="st">"bio02_1981-2010_observed"</span><span class="op">)</span>,</span>
<span>  tile_ids <span class="op">=</span> <span class="va">tile_id</span>,</span>
<span>  download <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  download_dir <span class="op">=</span> <span class="va">wdir</span>,</span>
<span>  file_format <span class="op">=</span> <span class="st">"txt"</span>,</span>
<span>  delete_zips <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  ignore_missing <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  tempdir <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The tables have been downloaded to a new folder which has been named
according to each dataset and automatically unzipped. By taking a look
at any of the tables with climate information we can see that for every
sub-catchment different statistics (i.e., minimum, maximum, mean,
standard deviation, range) are available and that the format is columns
separated by space.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read first 10 rows without reading the table into R</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span> <span class="st">"head chelsa_bioclim_v2_1/1981-2010_observed/bio01/bio01_1981-2010_observed_h18v02.txt "</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>Land cover: forest proportion per sub-catchment for the year
2020</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_env90m_tables.html">download_landcover_tables</a></span><span class="op">(</span></span>
<span>  base_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"c60"</span><span class="op">)</span>,</span>
<span>  years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2020"</span><span class="op">)</span>,</span>
<span>  tile_ids <span class="op">=</span> <span class="va">tile_id</span>,</span>
<span>  download <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  download_dir <span class="op">=</span> <span class="va">wdir</span>,</span>
<span>  file_format <span class="op">=</span> <span class="st">"txt"</span>,</span>
<span>  delete_zips <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  ignore_missing <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  tempdir <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The land cover tables, unlike the climate tables, only have one
column containing the proportion of the specific land cover category in
each sub-catchment.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read first 10 rows without reading the table into R</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">" head esa_cci_landcover_v2_1_1/c60/c60_2020_h18v02.txt"</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>Hydrography90m: flow accumulation, length and slope of the stream
segment</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_env90m_tables.html">download_hydrography90m_tables</a></span><span class="op">(</span></span>
<span>  subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"flow"</span>, <span class="st">"length"</span>, <span class="st">"slope_grad_dw_cel"</span><span class="op">)</span>,</span>
<span>  tile_ids <span class="op">=</span> <span class="va">tile_id</span>,</span>
<span>  download <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  download_dir <span class="op">=</span> <span class="va">wdir</span>,</span>
<span>  file_format <span class="op">=</span> <span class="st">"txt"</span>,</span>
<span>  delete_zips <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  ignore_missing <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  tempdir <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We have downloaded approximately 14 GB of information. The tables at
this point consist of the environmental information for the selected
variables for all sub-catchments in each of the four complete tiles. But
we are only interested in the information of those sub-catchments within
our bounding box. To achieve this filtering and join all environmental
variables in one single table we will use the function
<em>get_predict_table</em> in the next step.</p>
</div>
<div class="section level2">
<h2 id="prediction-table">Prediction table<a class="anchor" aria-label="anchor" href="#prediction-table"></a>
</h2>
<p>The prediction table contains the values of environmental variables
for all sub-catchments of interest. It is called “prediction table”
because it will be used as the reference table to predict the model’s
output using any of the <em>predict</em> functions in R. For example, we
will predict the habitat suitability values to all sub-catchments in
this table at the end of the exercise.</p>
<p>The <em>get_predict_table</em> function will join all environmental
variables based on the sub-catchments of interest; in our case, the
sub-catchment IDs available in the <em>subc_id</em> object (which we
have previously saved in the file <em>subc_ids.txt</em>).</p>
<p>The function can be run in parallel, with parallelisation occurring
at the level of the variable. Since we are using 6 variables in this
example, we can utilise 6 cores. To check the number of available cores
on your system, you can use the following line:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 14</span></span></code></pre>
<p>As a best practice, it is recommended to use at most the number of
available cores minus one.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_predict_table.html">get_predict_table</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bio01_1981-2010_observed"</span>, <span class="st">"bio02_1981-2010_observed"</span>, <span class="st">"c60_2020"</span>, <span class="st">"flow"</span>, <span class="st">"length"</span>, <span class="st">"slope_grad_dw_cel"</span><span class="op">)</span>,</span>
<span>  statistics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="st">"sd"</span><span class="op">)</span>,</span>
<span>  tile_id <span class="op">=</span> <span class="va">tile_id</span>,</span>
<span>  input_var_path <span class="op">=</span> <span class="va">wdir</span>,</span>
<span>  subcatch_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"subc_ids.txt"</span><span class="op">)</span>,</span>
<span>  out_file_path <span class="op">=</span> <span class="st">"predictTB.csv"</span>,</span>
<span>  read <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  n_cores <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p>Note that we specify the parameter read=TRUE, so that the table is
created as an R object. The table is automatically created on disk by
the function but the default parameter is FALSE because in some cases
the table could be very large and there is no need to load it into the R
workspace. In our example the table is 311 MB in size!</p>
<p>You can double check that all the sub-catchments are included in the
table and all the environmental parameters of interest are attached.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tb</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tb</span><span class="op">)</span></span></code></pre></div>
<p>The table should have 4,267,964 rows and 11 columns (since we are
retrieving the mean and standard deviation for some of the variables).
If the table was created successfully, we can remove the original tables
and save some disk space.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### remove original tables</span></span>
<span><span class="co"># remove folders</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="st">"chelsa_bioclim_v2_1"</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="st">"esa_cci_landcover_v2_1_1"</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="st">"hydrography90m_v1_0"</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="species-data">Species data<a class="anchor" aria-label="anchor" href="#species-data"></a>
</h2>
<p>We collected and filtered occurrence records for the fish species
<em>Zingel streber</em> from the GBIF repository. The final table
consists of three columns: species name, longitude and latitude
coordinates. The original data can be found <a href="https://www.gbif.org/occurrence/download/0028469-231002084531237" class="external-link">here</a>
<span class="citation">(<a href="#ref-gbifdata">GBIF.Org User,
2023</a>)</span>.</p>
<p>Read the file into the R session and have a look at it</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"hydrography90m_test_data/hydrographr_data/Zingel_streber.csv"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">spdata</span></span></code></pre></div>
<pre><code><span><span class="co">##             Species Longitude Latitude</span></span>
<span><span class="co">##              &lt;char&gt;     &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">##   1: Zingel streber  15.36250 48.25417</span></span>
<span><span class="co">##   2: Zingel streber  20.26250 44.48750</span></span>
<span><span class="co">##   3: Zingel streber  18.71250 45.97917</span></span>
<span><span class="co">##   4: Zingel streber  15.36250 46.94583</span></span>
<span><span class="co">##   5: Zingel streber  15.99583 46.67917</span></span>
<span><span class="co">##  ---                                  </span></span>
<span><span class="co">## 324: Zingel streber  20.26393 45.14242</span></span>
<span><span class="co">## 325: Zingel streber  21.69275 43.53458</span></span>
<span><span class="co">## 326: Zingel streber  15.47700 46.76300</span></span>
<span><span class="co">## 327: Zingel streber  16.00200 46.67800</span></span>
<span><span class="co">## 328: Zingel streber  14.71600 48.18900</span></span></code></pre>
<p>Visualize the species occurrence records on a map.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert species data to a spatial vector object to plot the points</span></span>
<span><span class="va">spdata_vect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">spdata</span>, geom<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Longitude"</span>, <span class="st">"Latitude"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read the polygon of the Danube basin</span></span>
<span><span class="va">danube_pol</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"hydrography90m_test_data/hydrographr_data/DanubeMSK.gpkg"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/leaflet.html" class="external-link">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/addProviderTiles.html" class="external-link">addProviderTiles</a></span><span class="op">(</span><span class="st">'Esri.WorldShadedRelief'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-methods.html" class="external-link">setMaxBounds</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-layers.html" class="external-link">addCircles</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">spdata_vect</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-layers.html" class="external-link">addPolygons</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dan</span>, color <span class="op">=</span> <span class="st">"blue"</span>, stroke <span class="op">=</span> <span class="fl">0.7</span>, opacity <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">m</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="../reference/figures/danube_map.png" alt="Figure 3. Species occurrences in the Danube basin" width="80%"><p class="caption">
Figure 3. Species occurrences in the Danube basin
</p>
</div>
<!-- ![](../man/figures/danube_map.png) -->
</div>
<div class="section level2">
<h2 id="model-table">Model Table<a class="anchor" aria-label="anchor" href="#model-table"></a>
</h2>
<p>The next step is to prepare the so called <em>model fit table</em>.In
this table, we link the sub-catchments containing species occurrence
points with the environmental data previously compiled in the “predict
table”. For this purpose we use the function <code>get_model_fit</code>.
If we have many species of interest we can run this function in a for
loop to create the model fit table for each species separately.</p>
<p>Most of the algorithms available to run SDMs need presence and
absence data. In the lack of absence data, pseudoabsence points can be
generated in different ways. The function <code>get_model_fit</code>
provides this functionality and by default creates randomly a specified
number of pseudoabsences.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spptb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_modelfit_table.html">get_modelfit_table</a></span><span class="op">(</span></span>
<span>  data<span class="op">=</span><span class="va">spdata</span>,</span>
<span>  spec<span class="op">=</span><span class="st">"Species"</span>,</span>
<span>  lon<span class="op">=</span><span class="st">"Longitude"</span>,</span>
<span>  lat <span class="op">=</span> <span class="st">"Latitude"</span>,</span>
<span>  pseudoabs <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>  subc <span class="op">=</span> <span class="st">"subcatchments.tif"</span>,</span>
<span>  predict_table <span class="op">=</span> <span class="st">"predictTB.csv"</span>,</span>
<span>  mod_fit_table <span class="op">=</span> <span class="st">"modelFit.csv"</span>,</span>
<span>  read <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spptb</span><span class="op">)</span></span></code></pre></div>
<p>The new table consists of the sub-catchment IDs, a new column
indicating if the species is present (1) or absent (0) in the
sub-catchment and the values of all environmental variables in the
sub-catchment. In this case we created 5000 pseudo-absences.</p>
</div>
<div class="section level2">
<h2 id="application-of-a-species-distribution-model">Application of a Species Distribution Model<a class="anchor" aria-label="anchor" href="#application-of-a-species-distribution-model"></a>
</h2>
<p>There are many models or statistical techniques available to
delineate species geographic distributions. A common technique is random
forest (RF), a machine learning algorithm that is computationally very
efficient when dealing with large amounts of data and producing
constantly very accurate results.</p>
<div class="section level3">
<h3 id="model-training">Model training<a class="anchor" aria-label="anchor" href="#model-training"></a>
</h3>
<p>We need to be sure that the column of presence-absence (0-1)
information is set to a factor and that the table does not contain no
data values.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spptb</span><span class="op">$</span><span class="va">PresAbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/is.bool.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">spptb</span><span class="op">$</span><span class="va">PresAbs</span><span class="op">)</span></span>
<span><span class="va">spptb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">spptb</span><span class="op">)</span></span></code></pre></div>
<p>Now, we are a ready to run the model. We will use the function <a href="https://www.rdocumentation.org/packages/ranger/versions/0.16.0/topics/ranger" class="external-link">‘ranger’</a>
available in the ranger R package. We will first shorten the column
names of the table to avoid redundant information.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spptb</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"_1981-2010_observed"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spptb</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://imbs-hl.github.io/ranger/reference/ranger.html" class="external-link">ranger</a></span><span class="op">(</span><span class="va">spptb</span><span class="op">$</span><span class="va">PresAbs</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">spptb</span><span class="op">[</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">11</span><span class="op">]</span>,</span>
<span>                 replace <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                 probability <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-prediction">Model prediction<a class="anchor" aria-label="anchor" href="#model-prediction"></a>
</h3>
<p>Now we want to predict the probability of occurrence of the species
for the Danube basin. We predict by relating our model with the large
<em>predict table</em>. The process might require a lot of computing
resources, especially if the <em>predict table</em> is large as in our
case. An average laptop can easily run out of memory and the process can
crash. One solution is to run the prediction calculations in small
subsets of the large table. We can split the large table with the
function <code>split_table</code>. In the following code we will split
the large table (4,267,964 rows) in subsets of 500,000 records.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/split_table.html">split_table</a></span><span class="op">(</span><span class="st">"predictTB.csv"</span>, split<span class="op">=</span><span class="fl">500000</span>, <span class="va">wdir</span><span class="op">)</span></span></code></pre></div>
<p>The result is a list of 9 tables. By default, the function creates
new files with names starting with the prefix ‘predTB’.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"predTB*"</span><span class="op">)</span></span>
<span><span class="va">n_splits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"predTB*"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we can run the predictions for each subset table. We will store
the results of the 9 predictions in a list object. At the same time we
will store the sub-catchment IDs of each table in a different list
object.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create the output list</span></span>
<span><span class="va">pred_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">subc_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_splits</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Now predicting on chunk"</span>, <span class="va">i</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">arc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"predTB_"</span>, <span class="va">i</span>, <span class="st">".csv"</span><span class="op">)</span></span>
<span>    <span class="va">predtb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">arc</span><span class="op">)</span></span>
<span>    <span class="va">predtb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">predtb</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">predtb</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"_1981.2010_observed"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">predtb</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">predtb</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">subc</span> <span class="op">&lt;-</span> <span class="va">predtb</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">pred_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">subc_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">subc</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pred_sub</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"prob_0"</span>, <span class="st">"prob_1"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">subc_sub</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"subcID"</span></span>
<span>  </span>
<span>    <span class="va">pred_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred_sub</span></span>
<span>    <span class="va">subc_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">subc_sub</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The predictions consist of data frames with two columns. The first
column is the probability of absence and the second column the
probability of presence of the species. We are interested in the second
column. Let’s take a look at the first rows of the prediction in the
first table:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pred_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>We can now combine all predictions and sub-catchment IDs.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># combine all predictions</span></span>
<span><span class="va">pred_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="va">pred_list</span><span class="op">)</span></span>
<span><span class="co"># combine all sub-catchments</span></span>
<span><span class="va">subc_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="va">subc_list</span><span class="op">)</span></span></code></pre></div>
<p>Our final goal is to visualize the probability of occurrence -or
habitat suitability- of the fish species on a map of the Danube basin.
In order to transfer the prediction values into the map we will use the
function ‘reclass_raster’ to reclassify the sub-catchment raster values
with the prediction values. For this we need to first create a
reclassification rule data frame associating the sub-catchment IDs with
the prediction values in each sub-catchment. Importantly, the prediction
values need to be presented as integers, so we will multiply the
probability values by 100.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># multiply the probability values by 100</span></span>
<span><span class="va">pred_all</span><span class="op">$</span><span class="va">prob_1_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">pred_all</span><span class="op">$</span><span class="va">prob_1</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## merge the sub-catchment IDs and the prediction values</span></span>
<span><span class="va">reclassTB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">subc_all</span>, <span class="va">pred_all</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>We can now reclassify the sub-catchment raster</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/reclass_raster.html">reclass_raster</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">reclassTB</span>,</span>
<span>  rast_val <span class="op">=</span> <span class="st">"subcID"</span>,</span>
<span>  new_val <span class="op">=</span> <span class="st">"prob_1_int"</span>,</span>
<span>  raster_layer <span class="op">=</span> <span class="st">"subcatchments.tif"</span>,</span>
<span>  recl_layer <span class="op">=</span> <span class="st">"prediction.tif"</span>,</span>
<span>  read <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Visualization</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define colour palette</span></span>
<span><span class="va">num_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/colorNumeric.html" class="external-link">colorNumeric</a></span><span class="op">(</span></span>
<span>  <span class="fu">viridisLite</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">inferno</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span></span>
<span>  , domain <span class="op">=</span> <span class="va">pred_all</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span></span>
<span>  , na.color <span class="op">=</span> <span class="st">"transparent"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/leaflet.html" class="external-link">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-layers.html" class="external-link">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-methods.html" class="external-link">setMaxBounds</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">leafem</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/leafem/reference/addGeotiff.html" class="external-link">addGeotiff</a></span><span class="op">(</span></span>
<span>  file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/prediction.tif"</span><span class="op">)</span>, opacity <span class="op">=</span> <span class="fl">1</span>,</span>
<span>   colorOptions <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/leafem/reference/colorOptions.html" class="external-link">colorOptions</a></span><span class="op">(</span></span>
<span>                  palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">256</span>, palette <span class="op">=</span> <span class="st">"inferno"</span><span class="op">)</span>,</span>
<span>                  na.color <span class="op">=</span> <span class="st">"transparent"</span></span>
<span>                  <span class="op">)</span> <span class="co"># read external raster file without loading it to R</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">leaflet</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-layers.html" class="external-link">addCircles</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">spdata_vect</span>, color <span class="op">=</span> <span class="st">"turquoise"</span>, stroke <span class="op">=</span> <span class="cn">TRUE</span>,                      weight <span class="op">=</span> <span class="fl">5</span>, opacity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># add points</span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/addLegend.html" class="external-link">addLegend</a></span><span class="op">(</span>pal <span class="op">=</span> <span class="va">num_pal</span>,</span>
<span>           values <span class="op">=</span> <span class="va">pred_all</span><span class="op">$</span><span class="va">prob_1_int</span>,</span>
<span>           labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palette.html" class="external-link">palette</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>           title <span class="op">=</span> <span class="st">"Future habitat suitability map&lt;/br&gt;for Zingel streber"</span>,</span>
<span>           position <span class="op">=</span> <span class="st">"bottomleft"</span>, opacity <span class="op">=</span> <span class="fl">1</span>, labFormat <span class="op">=</span> <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/addLegend.html" class="external-link">labelFormat</a></span><span class="op">(</span>suffix <span class="op">=</span> <span class="st">"%"</span><span class="op">)</span><span class="op">)</span>  <span class="co"># add a legend</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/htmlwidgets/man/saveWidget.html" class="external-link">saveWidget</a></span><span class="op">(</span><span class="va">p</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/prediction_map.html"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="../reference/figures/danube_prediction_map.png" alt="Figure 4. Habitat suitability map of the species in the Danube basin" width="80%"><p class="caption">
Figure 4. Habitat suitability map of the species in the Danube basin
</p>
</div>
</div>
<div class="section level3 unnumbered">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0" line-spacing="2">
<div id="ref-amatulli2022hydrography90m" class="csl-entry">
Amatulli, G., Garcia Marquez, J., Sethi, T., Kiesel, J., Grigoropoulou,
A., Üblacker, M. M., … Domisch, S. (2022). Hydrography90m: A new
high-resolution global hydrographic dataset. <em>Earth System Science
Data</em>, <em>14</em>(10), 4525–4550.
</div>
<div id="ref-garcia2025environment90m" class="csl-entry">
García Márquez, J. R., Grigoropoulou, A., Tomiczek, T., Schürz, M.,
Bremerich, V., Torres-Cambas, Y., … Domisch, S. (2025).
<em>Environment90m: Globally standardized environmental variables for
spatial freshwater biodiversity science at high spatial resolution</em>
[Manuscript in preparation].
</div>
<div id="ref-gbifdata" class="csl-entry">
GBIF.Org User. (2023). <em>Occurrence download</em>. The Global
Biodiversity Information Facility. <a href="https://doi.org/10.15468/DL.QC7E3S" class="external-link">https://doi.org/10.15468/DL.QC7E3S</a>
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Marlene Schürz, Afroditi Grigoropoulou, Jaime Garcia Marquez, Yusdiel Torres Cambas, Christoph Schürz, Mathieu Floury, Thomas Tomiczek, Vanessa Bremerich, Merret Buurman, Giuseppe Amatulli, Sami Domisch.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
