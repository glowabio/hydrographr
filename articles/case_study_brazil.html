<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="hydrographr">
<title>Case study - São Francisco drainage basin • hydrographr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Case study - São Francisco drainage basin">
<meta property="og:description" content="hydrographr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hydrographr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.14</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/hydrographr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/case_study_brazil.html">Case study - São Francisco drainage basin</a>
    <a class="dropdown-item" href="../articles/case_study_cuba.html">Case study - Cuba</a>
    <a class="dropdown-item" href="../articles/linux_system_setup.html">Setting up the package requirements on Linux</a>
    <a class="dropdown-item" href="../articles/windows_system_setup.html">Setting up the package requirements on Windows</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/glowabio/hydrographr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="case_study_brazil_files/kePrint-0.0.1/kePrint.js"></script><link href="case_study_brazil_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Case study - São Francisco drainage basin</h1>
            <h3 data-toc-skip class="subtitle">Processing of spatial
data and calculating the number of dams and the distance along the
stream network to the clostest dam up- and downstream of fish occurence
sites</h3>
                        <h4 data-toc-skip class="author"></h4>
            
            <h4 data-toc-skip class="date">2023-05-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/glowabio/hydrographr/blob/HEAD/vignettes/case_study_brazil.Rmd" class="external-link"><code>vignettes/case_study_brazil.Rmd</code></a></small>
      <div class="d-none name"><code>case_study_brazil.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>The following example showcases the functionality of the
<code>hydrographr</code> package along a workflow to analyse the
fragmentation of a stream network. We will evaluate how many dams are
up- and downstream of each fish occurrence site and the distance along
the stream network from each fish occurrence site to the next dam for
the current and future state.</p>
<p>In our example we will focus on the catfish species <em>Conorhynchos
conirostris</em>, which is a catfish species endemic to the São
Francisco drainage basin in Brazil. The catfish is listed as
‘endangered’ by the IUCN red list. Wetlands are the preferred habitat
and it is migrating for spawning.As an migratory species, it is mostly
threatened by dams along the stream network. Further, it is threatened
by fishing during the spawning season in the upstream part of the
river.</p>
<p>We will start by defining the regular tiles of the Hydrography90m
(Amatulli et al., 2022) where the occurrence points of the species are
located. Afterwards we will download the Hydrography90m layers,
filter/crop and merge them. Then we will filter our fish occurrence and
dam point locations using the polygon of the drainage basin and snap the
point locations to the stream network. Afterwards, we will reduce our
drainage basin using the dam upstream of all fish occurrence sites as
our outlet location to calculate the upstream catchment from this point
location. In a next step, we will calculate the distances along the
stream network between each point location (fish and dams) and get the
up- and downstream stream egments from each point locations as a graph.
Afterwards, we will query the tables and evaluate the shortest distance
to the next dam as well as the number of dams.</p>
<p><img src="../reference/figures/workflow.png"></p>
<p>Let’s get started!</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glowabio.github.io/hydrographr/" class="external-link">hydrographr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rgbif" class="external-link">rgbif</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org/" class="external-link">forcats</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/leaflet/" class="external-link">leaflet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define working directory</span></span>
<span><span class="va">wdir</span> <span class="op">&lt;-</span> <span class="st">"my/working/directory/data_brazil"</span></span>
<span><span class="co"># Set defined working directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">wdir</span><span class="op">)</span></span>
<span><span class="co"># Create a directory to store all the data of the case study</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"data"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="species-data">Species data<a class="anchor" aria-label="anchor" href="#species-data"></a>
</h3>
<p>We will start by downloading occurrence records of <em>Conorhynchos
conirostris</em> from GBIF.org using the R package
<code>rgbif</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download occurrence data with coordinates from GBIF</span></span>
<span><span class="va">gbif_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/occ_data.html" class="external-link">occ_data</a></span><span class="op">(</span>scientificName <span class="op">=</span> <span class="st">"Conorhynchos conirostris"</span>, </span>
<span>                      hasCoordinate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># To cite the data use:</span></span>
<span><span class="co"># gbif_citation(gbif_data)        </span></span>
<span></span>
<span><span class="co"># Clean the data</span></span>
<span><span class="va">spdata</span> <span class="op">&lt;-</span> <span class="va">gbif_data</span><span class="op">$</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">decimalLongitude</span>, <span class="va">decimalLatitude</span>, <span class="va">species</span>, <span class="va">occurrenceStatus</span>, </span>
<span>         <span class="va">country</span>, <span class="va">year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>occurence_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"longitude"</span> <span class="op">=</span> <span class="st">"decimalLongitude"</span>,</span>
<span>         <span class="st">"latitude"</span> <span class="op">=</span> <span class="st">"decimalLatitude"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:200px; overflow-x: scroll; width:700px; ">
<table class="table table table-striped" style="width: auto !important; ">
<thead><tr>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
occurence_id
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
longitude
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
latitude
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
species
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
occurrenceStatus
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
country
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
year
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-44.88582
</td>
<td style="text-align:right;">
-17.25355
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
2021
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
-43.59583
</td>
<td style="text-align:right;">
-13.76361
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
2020
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
-40.49297
</td>
<td style="text-align:right;">
-12.94839
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
2020
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
-45.78083
</td>
<td style="text-align:right;">
-17.17831
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
2018
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
-45.90444
</td>
<td style="text-align:right;">
-17.07472
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
2014
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
-46.89351
</td>
<td style="text-align:right;">
-17.39792
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
2012
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
-45.24500
</td>
<td style="text-align:right;">
-18.13600
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
2009
</td>
</tr>
<tr>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
-45.24000
</td>
<td style="text-align:right;">
-18.14000
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
2009
</td>
</tr>
<tr>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
-43.13889
</td>
<td style="text-align:right;">
-11.09222
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
2001
</td>
</tr>
<tr>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
-44.95466
</td>
<td style="text-align:right;">
-17.35678
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
1998
</td>
</tr>
<tr>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
-43.96667
</td>
<td style="text-align:right;">
-14.91667
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
1998
</td>
</tr>
<tr>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
-44.95496
</td>
<td style="text-align:right;">
-17.33615
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
1942
</td>
</tr>
<tr>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
-44.35700
</td>
<td style="text-align:right;">
-15.49277
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
1932
</td>
</tr>
<tr>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
-44.35700
</td>
<td style="text-align:right;">
-15.49277
</td>
<td style="text-align:left;">
Conorhynchos conirostris
</td>
<td style="text-align:left;">
PRESENT
</td>
<td style="text-align:left;">
Brazil
</td>
<td style="text-align:right;">
1907
</td>
</tr>
</tbody>
</table>
</div>
<p>Let’s visualise the species occurrences on a map.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the extent</span></span>
<span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">spdata</span><span class="op">$</span><span class="va">longitude</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">spdata</span><span class="op">$</span><span class="va">latitude</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">spdata</span><span class="op">$</span><span class="va">longitude</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">spdata</span><span class="op">$</span><span class="va">latitude</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define color palette for the different years of record</span></span>
<span><span class="va">factpal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html" class="external-link">colorFactor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">spdata</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span>, <span class="va">spdata</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create leaflet plot</span></span>
<span><span class="va">spdata_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html" class="external-link">leaflet</a></span><span class="op">(</span><span class="va">spdata</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/addProviderTiles.html" class="external-link">addProviderTiles</a></span><span class="op">(</span><span class="st">'Esri.WorldShadedRelief'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-methods.html" class="external-link">setMaxBounds</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html" class="external-link">addCircles</a></span><span class="op">(</span>lng <span class="op">=</span> <span class="op">~</span><span class="va">longitude</span>, lat <span class="op">=</span> <span class="op">~</span> <span class="va">latitude</span>, color <span class="op">=</span>  <span class="op">~</span><span class="fu">factpal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/is.bool.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              opacity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/addLegend.html" class="external-link">addLegend</a></span><span class="op">(</span>pal <span class="op">=</span> <span class="va">factpal</span>, values <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/is.bool.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>            title <span class="op">=</span> <span class="st">"Year of record"</span><span class="op">)</span></span>
<span><span class="va">spdata_plot</span></span></code></pre></div>
<p><img src="../reference/figures/occurrence_locations.png"></p>
</div>
<div class="section level3">
<h3 id="download-files">Download files<a class="anchor" aria-label="anchor" href="#download-files"></a>
</h3>
<p>In order to download layers of the Hydrography90m, we need to know
the IDs of the 20°x20° tiles in which the occurrence sites are located.
We can obtain these IDs using the function <em>get_tile_id()</em>. This
function downloads and uses the auxiliary raster file that contains all
the regional units globally, and thus requires an active internet
connection.</p>
<p><img src="../reference/figures/workflow1.png"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the tile IDs where the points are located</span></span>
<span><span class="va">tile_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_tile_id.html">get_tile_id</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">spdata</span>, lon <span class="op">=</span> <span class="st">"longitude"</span>, lat <span class="op">=</span> <span class="st">"latitude"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tile_id</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "h12v08" "h12v10" "h14v08"</span></span></code></pre>
<p>Currently the function returns all the tiles of the regional unit
where the input points are located. However, some of them may be far
from the study area and hence not always needed in further steps. Please
double check which tile IDs are relevant for your purpose using the
<strong>Tile map</strong> found <a href="https://hydrography.org/hydrography90m/hydrography90m_layers/" class="external-link">here</a>.</p>
<p>In our case, the São Francisco river basin spreads across all three
tiles, so we will keep all.</p>
<p>Let’s define the Hydrography90m raster layers and GeoPackages that we
would like to download. We will use the <a href="https://geo.igb-berlin.de/maps/new?layer=geonode:hydrography90m_v1_basin_cog&amp;view=True" class="external-link">basin</a>
raster and vector layer, which contains the drainage basin of the São
Francisco river basin. The <a href="https://geo.igb-berlin.de/maps/new?layer=geonode:hydrography90m_v1_sub_catchment_cog&amp;view=True" class="external-link">sub_catchment</a>
layer, which contains the sub-catchment for each single stream segment
with an unique ID. We will need these layers for cropping and
filtering.</p>
<p>We will need the raster layer of the stream <a href="https://geo.igb-berlin.de/layers/geonode:hydrography90m_v1_segment_cog&amp;view=True" class="external-link">segment</a>
and the flow <a href="https://geo.igb-berlin.de/layers/geonode:hydrography90m_v1_accumulation_cog&amp;view=True" class="external-link">accumulation</a>
to snap our fish occurrence and dam sites to the stream network.</p>
<p>Further, we will download the raster layer of the <a href="https://geo.igb-berlin.de/layers/geonode:hydrography90m_v1_direction_cog&amp;view=True" class="external-link">direction</a>
to calculate the upstream catchment from a defined point location.</p>
<p>We will need the Geopackage <a href="https://geo.igb-berlin.de/maps/new?layer=geonode:hydrography90m_v1_stream_order_strahler_cog&amp;view=True" class="external-link">order_vect_segment</a>,
containing the stream network, with the stream (sub-catchment) IDs, the
ID of the next stream and some additional attributes. We will need the
GeoPackage to to calculate the distance between point locations and to
create a graph to find out which stream segments are up- and downstream
of the fish occurrence sites.</p>
<p>A list of all available Hydrography90m variables, as well as details
and visualisations are available <a href="https://hydrography.org/hydrography90m/hydrography90m_layers/" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Variables in raster format</span></span>
<span><span class="va">vars_tif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basin"</span>, <span class="st">"sub_catchment"</span>, <span class="st">"segment"</span>, <span class="st">"accumulation"</span>, <span class="st">"direction"</span><span class="op">)</span></span>
<span><span class="co"># Variables in vector format</span></span>
<span><span class="va">vars_gpkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basin"</span>, <span class="st">"order_vect_segment"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download the .tif tiles of the desired variables</span></span>
<span><span class="fu"><a href="../reference/download_tiles.html">download_tiles</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">vars_tif</span>, tile_id <span class="op">=</span> <span class="va">tile_id</span>, file_format <span class="op">=</span> <span class="st">"tif"</span>,</span>
<span>               download_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/data"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download the .gpkg tiles of the desired variables</span></span>
<span><span class="fu"><a href="../reference/download_tiles.html">download_tiles</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">vars_gpkg</span>, tile_id <span class="op">=</span> <span class="va">tile_id</span>, file_format <span class="op">=</span> <span class="st">"gpkg"</span>,</span>
<span>               download_dir <span class="op">=</span>   <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/data"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="filtering-cropping-and-merging">Filtering, cropping and merging<a class="anchor" aria-label="anchor" href="#filtering-cropping-and-merging"></a>
</h3>
<p>After having downloaded all the layers, we need to filter and crop
them to the extent of our study area.</p>
<p>For a faster processing, we recommend to filter (vector) or crop
(raster) the files first and than merge them.</p>
<p>First, we will filter the GeoPackage tiles containing the drainage
basins for the basin ID 481051 (São Francisco drainage basin) and merge
them to get the extent of the drainage basin of São Francisco river. We
will then use the polygon of the drainage basin to crop all downloaded
raster tiles and then merge them. Afterwards, we will extract the unique
sub-catchment IDs from the raster layer to filter the stream network
GeoPackage tiles (oder_vect_segment) for stream segments with the same
sub-catchment ID and merge them.</p>
<p><img src="../reference/figures/workflow2.png"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a directory for the São Francisco drainage basin</span></span>
<span><span class="va">saofra_dir</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/data/basin_481051"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">saofra_dir</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">saofra_dir</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Get the full path of the basin  GeoPackage tiles</span></span>
<span><span class="va">basin_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">wdir</span>, pattern <span class="op">=</span> <span class="st">"basin_h[v0-8]+.gpkg$"</span>,</span>
<span>                         full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter basin ID from the GeoPackages of the basin tiles</span></span>
<span><span class="co"># Save the vector data of the São Francisco drainage basin</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">itile</span> <span class="kw">in</span> <span class="va">basin_dir</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">filtered_tile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_geopackage.html">read_geopackage</a></span><span class="op">(</span><span class="va">itile</span>,</span>
<span>                                   import_as <span class="op">=</span> <span class="st">"sf"</span>,</span>
<span>                                   subc_id <span class="op">=</span> <span class="fl">481051</span>,</span>
<span>                                   name <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span>  </span>
<span>    </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">write_sf</a></span><span class="op">(</span><span class="va">filtered_tile</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">saofra_dir</span>,</span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">itile</span><span class="op">)</span>, <span class="st">".gpkg"</span><span class="op">)</span>,</span>
<span>                                       <span class="st">"_tmp.gpkg"</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">"/"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Merge filtered GeoPackage tiles</span></span>
<span><span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            tile_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">saofra_dir</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                    pattern <span class="op">=</span> <span class="st">"basin_.+_tmp.gpkg$"</span><span class="op">)</span>,</span>
<span>            out_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            file_name <span class="op">=</span> <span class="st">"basin_481051.gpkg"</span>,</span>
<span>            name <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>            read <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Get the full path of the raster tiles</span></span>
<span><span class="va">raster_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/data/r.watershed"</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">".tif"</span>,</span>
<span>                       full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Crop raster tiles to the extent of the drainage basin</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">itile</span> <span class="kw">in</span> <span class="va">raster_dir</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="../reference/crop_to_extent.html">crop_to_extent</a></span><span class="op">(</span>raster_layer <span class="op">=</span> <span class="va">itile</span>,</span>
<span>                 vector_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">saofra_dir</span>, <span class="st">"/basin_481051.gpkg"</span><span class="op">)</span>,</span>
<span>                 out_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>                 file_name <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">itile</span><span class="op">)</span>, <span class="st">".tif"</span><span class="op">)</span>, </span>
<span>                                     <span class="st">"_tmp.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span>  </span>
<span></span>
<span><span class="co"># Merge the cropped raster layers of the different variables</span></span>
<span><span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            tile_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">saofra_dir</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                    pattern <span class="op">=</span> <span class="st">"basin_.+_tmp.tif$"</span><span class="op">)</span>,</span>
<span>            out_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            file_name <span class="op">=</span> <span class="st">"basin_481051.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            tile_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">saofra_dir</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                    pattern <span class="op">=</span> <span class="st">"segment_.+_tmp.tif$"</span><span class="op">)</span>,</span>
<span>            out_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            file_name <span class="op">=</span> <span class="st">"segment_481051.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            tile_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">saofra_dir</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                    pattern <span class="op">=</span> <span class="st">"accumulation_.+_tmp.tif$"</span><span class="op">)</span>,</span>
<span>            out_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            file_name <span class="op">=</span> <span class="st">"accumulation_481051.tif"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            tile_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">saofra_dir</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                    pattern <span class="op">=</span> <span class="st">"direction_.+_tmp.tif$"</span><span class="op">)</span>,</span>
<span>            out_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            file_name <span class="op">=</span> <span class="st">"direction_481051.tif"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Merge the cropped sub-catchment raster layers and load the file after merging</span></span>
<span><span class="va">subc_layer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>                          tile_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">saofra_dir</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                                  pattern <span class="op">=</span> <span class="st">"sub_.+_tmp.tif$"</span><span class="op">)</span>,</span>
<span>                          out_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>                          file_name <span class="op">=</span> <span class="st">"sub_catchment_481051.tif"</span>,</span>
<span>                          read <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">subc_layer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">saofra_dir</span>, <span class="st">"/sub_catchment_481051.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Get all sub-catchment IDs of the São Francisco drainage basin</span></span>
<span><span class="va">subc_ids</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">subc_layer</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Get the full path of the stream order segment GeoPackages tile</span></span>
<span><span class="va">order_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">wdir</span>, pattern <span class="op">=</span> <span class="st">"order_.+_h[v0-8]+.gpkg$"</span>,</span>
<span>                        full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter the sub-catchment IDs from the GeoPackages of the order_vector_segment</span></span>
<span><span class="co"># tiles (sub-catchment ID = stream ID)</span></span>
<span><span class="co"># Save the stream segments of the São Francisco drainage basin</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">itile</span> <span class="kw">in</span> <span class="va">order_dir</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">filtered_tile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_geopackage.html">read_geopackage</a></span><span class="op">(</span><span class="va">itile</span>,</span>
<span>                                   import_as <span class="op">=</span> <span class="st">"sf"</span>,</span>
<span>                                   subc_id <span class="op">=</span> <span class="va">subc_ids</span><span class="op">$</span><span class="va">sub_catchment_481051</span>,</span>
<span>                                   name <span class="op">=</span> <span class="st">"stream"</span><span class="op">)</span></span>
<span>  </span>
<span>   </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">write_sf</a></span><span class="op">(</span><span class="va">filtered_tile</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">saofra_dir</span>,</span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">itile</span><span class="op">)</span>, <span class="st">".gpkg"</span><span class="op">)</span>,</span>
<span>                                       <span class="st">"_tmp.gpkg"</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">"/"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span></span>
<span><span class="co"># Merge filtered GeoPackage tiles</span></span>
<span><span class="co"># This process takes a few minutes</span></span>
<span><span class="fu"><a href="../reference/merge_tiles.html">merge_tiles</a></span><span class="op">(</span>tile_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            tile_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">saofra_dir</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                    pattern <span class="op">=</span> <span class="st">"order_.+_tmp.gpkg$"</span><span class="op">)</span>,</span>
<span>            out_dir <span class="op">=</span> <span class="va">saofra_dir</span>,</span>
<span>            file_name <span class="op">=</span> <span class="st">"order_vect_segment_481051.gpkg"</span>,</span>
<span>            name <span class="op">=</span> <span class="st">"stream"</span>,</span>
<span>            read <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Delete temporary files of the filtered and cropped tiles </span></span>
<span><span class="va">tmp_files</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">saofra_dir</span>, pattern <span class="op">=</span> <span class="st">"_tmp."</span>, </span>
<span>                         full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="va">tmp_files</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="filtering-of-the-species-occurrence-and-dam-locations">Filtering of the species occurrence and dam locations<a class="anchor" aria-label="anchor" href="#filtering-of-the-species-occurrence-and-dam-locations"></a>
</h3>
<p>The information of present and future dam locations is provided by
the GRanD and the FHRed database, respectively. Both datasets can be
downloaded from <a href="https://www.globaldamwatch.org/directory" class="external-link">globaldamwatch.org</a>.</p>
<p>To filter the point locations of the fish occurrence and dams we will
use the polygon of the drainage basin to only keep the locations which
are located within the drainage basin. For this step we will use the
functions of the <code>sf</code> package.</p>
<p><img src="../reference/figures/workflow3.png"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the GRanD data shape file</span></span>
<span><span class="va">grand_pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/data/GRanD_Version_1_3/GRanD_dams_v1_3.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Load FHRed dataset</span></span>
<span><span class="va">fhred_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">wdir</span>, <span class="st">"/data/FHReD_2015/FHReD_2015_future_dams_Zarfl_et_al_beta_version.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Load the polygon of the drainage basin</span></span>
<span><span class="va">basin_poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">saofra_dir</span>,<span class="st">"/basin_481051.gpkg"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a simply feature for the function st_filter</span></span>
<span><span class="va">spdata_pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">spdata</span>,  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longitude"</span>,<span class="st">"latitude"</span><span class="op">)</span>, remove <span class="op">=</span> <span class="cn">FALSE</span>, crs<span class="op">=</span><span class="st">"WGS84"</span><span class="op">)</span></span>
<span><span class="va">fhred_pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">fhred_corr</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lon_Cleaned"</span>,<span class="st">"LAT_cleaned"</span><span class="op">)</span>, crs<span class="op">=</span><span class="st">"WGS84"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Only keep species occurrence and dam sites within the drainage basin</span></span>
<span><span class="va">spdata_pts_481051</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_filter</a></span><span class="op">(</span><span class="va">spdata_pts</span>, <span class="va">basin_poly</span><span class="op">)</span></span>
<span><span class="va">grand_pts_481051</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_filter</a></span><span class="op">(</span><span class="va">grand_pts</span>, <span class="va">basin_poly</span><span class="op">)</span></span>
<span><span class="va">fhred_pts_481051</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_filter</a></span><span class="op">(</span><span class="va">fhred_pts</span>, <span class="va">basin_poly</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Transfer the simply feature back to a data.frame and harmonize column names</span></span>
<span><span class="co"># Existing dams (ED)</span></span>
<span><span class="va">existing_dams</span> <span class="op">&lt;-</span> <span class="va">grand_pts_481051</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>longitude <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>         latitude <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"ED"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>site_id <span class="op">=</span> <span class="va">GRAND_ID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site_id</span>, <span class="va">type</span>, <span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Future dams (Under construction UD, planned PD)</span></span>
<span><span class="va">future_dams</span> <span class="op">&lt;-</span> <span class="va">fhred_pts_481051</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>longitude <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>         latitude <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">Stage</span>, <span class="st">"D"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>site_id <span class="op">=</span> <span class="va">DAM_ID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site_id</span>, <span class="va">type</span>, <span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fish occurrence (FS)</span></span>
<span><span class="va">species_occurrence</span> <span class="op">&lt;-</span> <span class="va">spdata_pts_481051</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"FS"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>site_id <span class="op">=</span> <span class="va">occurence_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site_id</span>, <span class="va">type</span>, <span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bind the data.frames of the dame locations and the fish occurrence</span></span>
<span><span class="co"># Remove sites of the same type with duplicated coordinates</span></span>
<span><span class="va">point_locations</span> <span class="op">&lt;-</span> <span class="va">existing_dams</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">future_dams</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">species_occurrence</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">longitude</span>, <span class="va">latitude</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="snap-species-occurrence-and-dam-sites-to-a-stream-segment-within-a-certain-distance-and-with-a-certain-flow-accumulation">Snap species occurrence and dam sites to a stream segment within a
certain distance and with a certain flow accumulation<a class="anchor" aria-label="anchor" href="#snap-species-occurrence-and-dam-sites-to-a-stream-segment-within-a-certain-distance-and-with-a-certain-flow-accumulation"></a>
</h3>
<p>Before we can calculate the upstream catchment for a defined point
location or the distance along the stream network between species
occurrence and dam sites, we need to snap the coordinates of the sites
to the stream network. (Recorded coordinates of point locations usually
do not exactly overlap with the digital stream network and therefore
need to be corrected slightly.)</p>
<p>The <code>hydrographr</code> package offers two different snapping
functions the <code>snap_to_network</code> and the
<code>snap_to_subc_segment</code>. The first function uses a defined
distance radius and a flow accumulation threshold, while the second
function snaps the point location to the stream segment of the
sub-catchment the point was originally located.</p>
<p>For this case study we will use the function
<code>snap_to_network</code> to be able to define a certain flow
accumulation threshold and to ensure that the fish occurrence and dam
sites will not be snapped to a headwater stream (first order stream)
also there is a higher order stream next to it.</p>
<p><img src="../reference/figures/snapping.png"></p>
<p>The function is implemented in a for-loop to start searching for
streams with a very high flow accumulation of 400,000 km² in a very
short distance and than slowly decrease the flow accumulation to 100
km². If there are still sites left which were not snapped to stream
segment yet. The distance will increase from 10 up to 30 cells.</p>
<p>In addition to the new coordinates the function will also report the
unique sub-catchment ID.</p>
<p><img src="../reference/figures/workflow4.png"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define full path to the stream network raster layer</span></span>
<span><span class="va">stream_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">saofra_dir</span>, <span class="st">"/segment_481051.tif"</span><span class="op">)</span></span>
<span><span class="co"># Define full path to the flow accumulation raster layer</span></span>
<span><span class="va">flow_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">saofra_dir</span>, <span class="st">"/accumulation_481051.tif"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Define thresholds for the flow accumulation of the stream segment, where</span></span>
<span><span class="co"># the point location should be snapped to</span></span>
<span><span class="va">accu_threshold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">400000</span>, <span class="fl">300000</span>, <span class="fl">100000</span>, <span class="fl">50000</span>, <span class="fl">10000</span>, <span class="fl">5000</span>, <span class="fl">1000</span>, <span class="fl">500</span>, <span class="fl">100</span><span class="op">)</span> </span>
<span><span class="co"># Define the distance radius</span></span>
<span><span class="va">dist_radius</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a temporary data.table</span></span>
<span><span class="va">point_locations_tmp</span> <span class="op">&lt;-</span> <span class="va">point_locations</span></span>
<span></span>
<span><span class="co"># Note: For loop takes about 9 minutes</span></span>
<span><span class="va">first</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">idist</span> <span class="kw">in</span> <span class="va">dist_radius</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>   <span class="co"># If the distance increases to 20 cells only a flow accumulation of 100 km²</span></span>
<span>   <span class="co"># will be used</span></span>
<span>   <span class="kw">if</span> <span class="op">(</span><span class="va">idist</span> <span class="op">==</span> <span class="fl">20</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Set accu_threshold to 100</span></span>
<span>    <span class="va">accu_threshold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span>   <span class="op">}</span></span>
<span>  </span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">iaccu</span> <span class="kw">in</span> <span class="va">accu_threshold</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Snap point locations to the stream network</span></span>
<span>    <span class="va">point_locations_snapped_tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/snap_to_network.html">snap_to_network</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_locations_tmp</span>,</span>
<span>                                                   lon <span class="op">=</span> <span class="st">"longitude"</span>,</span>
<span>                                                   lat <span class="op">=</span> <span class="st">"latitude"</span>,</span>
<span>                                                   id <span class="op">=</span> <span class="st">"site_id"</span>,</span>
<span>                                                   stream_layer <span class="op">=</span> <span class="va">stream_rast</span>,</span>
<span>                                                   accu_layer <span class="op">=</span> <span class="va">flow_rast</span>,</span>
<span>                                                   method <span class="op">=</span> <span class="st">"accumulation"</span>,</span>
<span>                                                   distance <span class="op">=</span> <span class="va">idist</span>,</span>
<span>                                                   accumulation <span class="op">=</span> <span class="va">iaccu</span>,</span>
<span>                                                   quiet <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Keep point location with NAs for the next loop</span></span>
<span>    <span class="va">point_locations_tmp</span> <span class="op">&lt;-</span> <span class="va">point_locations_snapped_tmp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">subc_id_snap_accu</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">first</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Keep the point locations with the new coordinates and remove rows with NA</span></span>
<span>    <span class="va">point_locations_snapped</span> <span class="op">&lt;-</span> <span class="va">point_locations_snapped_tmp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">subc_id_snap_accu</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">first</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Bind the new data.frame to the data.frame of the loop before</span></span>
<span>    <span class="co"># and remove the NA</span></span>
<span>    <span class="va">point_locations_snapped</span> <span class="op">&lt;-</span> <span class="va">point_locations_snapped</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">point_locations_snapped_tmp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">subc_id_snap_accu</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="op">}</span></span>
<span>    </span>
<span><span class="op">}</span></span></code></pre></div>
<p>In some cases the GRASS GIS function r.stream.snap does not snap some
of the sites to the stream network, no matter how much you increase the
distance radius. If this happens the coordinates need to be changed
slightly within the same cell until the point gets snapped. I might
happen that this needs to be done multiple times.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the snapping function until all points are snapped</span></span>
<span><span class="co"># Note the while conditions runs a few times and</span></span>
<span><span class="co"># takes about 5 minutes</span></span>
<span><span class="kw">while</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">point_locations_tmp</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create random number smaller than the size if a cell</span></span>
<span>  <span class="va">rn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>, min<span class="op">=</span><span class="op">-</span><span class="fl">0.000833333</span>, max<span class="op">=</span><span class="op">+</span><span class="fl">0.000833333</span><span class="op">)</span></span>
<span>  <span class="co"># Add random number to the longitude and latitude </span></span>
<span>  <span class="va">point_locations_tmp</span> <span class="op">&lt;-</span> <span class="va">point_locations_tmp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>longitude <span class="op">=</span> <span class="va">longitude</span> <span class="op">+</span> <span class="va">rn</span>,</span>
<span>           latitude <span class="op">=</span> <span class="va">latitude</span> <span class="op">+</span> <span class="va">rn</span><span class="op">)</span></span>
<span>      </span>
<span>  <span class="va">point_locations_snapped_tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/snap_to_network.html">snap_to_network</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_locations_tmp</span>,</span>
<span>                                                   lon <span class="op">=</span> <span class="st">"longitude"</span>,</span>
<span>                                                   lat <span class="op">=</span> <span class="st">"latitude"</span>,</span>
<span>                                                   id <span class="op">=</span> <span class="st">"site_id"</span>,</span>
<span>                                                   stream_layer <span class="op">=</span> <span class="va">stream_rast</span>,</span>
<span>                                                   accu_layer <span class="op">=</span> <span class="va">flow_rast</span>,</span>
<span>                                                   method <span class="op">=</span> <span class="st">"accumulation"</span>,</span>
<span>                                                   distance <span class="op">=</span> <span class="va">idist</span>,</span>
<span>                                                   accumulation <span class="op">=</span> <span class="va">iaccu</span>,</span>
<span>                                                   quiet <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="co"># Keep point location with NAs for the next loop</span></span>
<span>  <span class="va">point_locations_tmp</span> <span class="op">&lt;-</span> <span class="va">point_locations_snapped_tmp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">subc_id_snap_accu</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="co"># Bind the new data.frame to the data.frame of the loop before</span></span>
<span>  <span class="co"># and remove the NA</span></span>
<span>  <span class="va">point_locations_snapped</span> <span class="op">&lt;-</span> <span class="va">point_locations_snapped</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">point_locations_snapped_tmp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">subc_id_snap_accu</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:200px; overflow-x: scroll; width:700px; ">
<table class="table table table-striped" style="width: auto !important; ">
<thead><tr>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
site_id
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
longitude
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
latitude
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
lon_snap_accu
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
lat_snap_accu
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
subc_id_snap_accu
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-44.88582
</td>
<td style="text-align:right;">
-17.25355
</td>
<td style="text-align:right;">
-44.88542
</td>
<td style="text-align:right;">
-17.25375
</td>
<td style="text-align:right;">
168036446
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
-45.90444
</td>
<td style="text-align:right;">
-17.07472
</td>
<td style="text-align:right;">
-45.90458
</td>
<td style="text-align:right;">
-17.07458
</td>
<td style="text-align:right;">
167997751
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
-45.24500
</td>
<td style="text-align:right;">
-18.13600
</td>
<td style="text-align:right;">
-45.24542
</td>
<td style="text-align:right;">
-18.13625
</td>
<td style="text-align:right;">
168219537
</td>
</tr>
<tr>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
-43.13889
</td>
<td style="text-align:right;">
-11.09222
</td>
<td style="text-align:right;">
-43.13292
</td>
<td style="text-align:right;">
-11.09125
</td>
<td style="text-align:right;">
166443527
</td>
</tr>
<tr>
<td style="text-align:right;">
473
</td>
<td style="text-align:right;">
-45.36667
</td>
<td style="text-align:right;">
-22.37292
</td>
<td style="text-align:right;">
-45.36708
</td>
<td style="text-align:right;">
-22.37292
</td>
<td style="text-align:right;">
168880587
</td>
</tr>
<tr>
<td style="text-align:right;">
484
</td>
<td style="text-align:right;">
-44.84444
</td>
<td style="text-align:right;">
-22.23542
</td>
<td style="text-align:right;">
-44.84458
</td>
<td style="text-align:right;">
-22.23542
</td>
<td style="text-align:right;">
168869594
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the polygon of the drainage basin</span></span>
<span><span class="va">basin_poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">saofra_dir</span>,<span class="st">"/basin_481051.gpkg"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the extent</span></span>
<span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">spdata</span><span class="op">$</span><span class="va">longitude</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">spdata</span><span class="op">$</span><span class="va">latitude</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">spdata</span><span class="op">$</span><span class="va">longitude</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">spdata</span><span class="op">$</span><span class="va">latitude</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">point_locations_snapped</span> <span class="op">&lt;-</span> <span class="va">point_locations</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">point_locations_snapped</span>, </span>
<span>            by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">type</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FS"</span>, <span class="st">"ED"</span>, <span class="st">"UD"</span>, <span class="st">"PD"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Define color palette for the different site types</span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html" class="external-link">colorFactor</a></span><span class="op">(</span></span>
<span>  palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'blue'</span>, <span class="st">'red'</span>, <span class="st">'orange'</span>, <span class="st">'yellow'</span><span class="op">)</span>,</span>
<span>  domain <span class="op">=</span> <span class="va">point_locations_snapped</span><span class="op">$</span><span class="va">type</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">labels</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Fish occurrence"</span>, <span class="st">"Existing dam"</span>, <span class="st">"Dam under construction "</span>, <span class="st">"Planned dam"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create leaflet plot</span></span>
<span><span class="va">locations_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html" class="external-link">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/addProviderTiles.html" class="external-link">addProviderTiles</a></span><span class="op">(</span><span class="st">'Esri.WorldShadedRelief'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-methods.html" class="external-link">setMaxBounds</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html" class="external-link">addPolygons</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">basin_poly</span> ,color <span class="op">=</span> <span class="st">"#444444"</span>, weight <span class="op">=</span> <span class="fl">1</span>, smoothFactor <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    opacity <span class="op">=</span> <span class="fl">1.0</span>, fillOpacity <span class="op">=</span> <span class="fl">0.5</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co">#addPolylines(data = stream_vect) %&gt;% </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html" class="external-link">addCircles</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_locations_snapped</span>, lng <span class="op">=</span> <span class="op">~</span><span class="va">lon_snap_accu</span>, </span>
<span>             lat <span class="op">=</span> <span class="op">~</span><span class="va">lat_snap_accu</span>, radius <span class="op">=</span> <span class="fl">0.2</span>, color <span class="op">=</span> <span class="op">~</span><span class="fu">pal</span><span class="op">(</span><span class="va">type</span><span class="op">)</span>,</span>
<span>              opacity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/addLegend.html" class="external-link">addLegend</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_locations_snapped</span>, pal <span class="op">=</span> <span class="va">pal</span>, values <span class="op">=</span> <span class="op">~</span><span class="va">type</span>,</span>
<span>            labFormat <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">type</span>, <span class="va">cuts</span>, <span class="va">p</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span><span class="op">}</span>,</span>
<span>            title <span class="op">=</span> <span class="st">"Site type"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">locations_plot</span></span></code></pre></div>
<p><img src="../reference/figures/point_location_snapped.png"></p>
</div>
<div class="section level3">
<h3 id="snap-point-locations-to-the-stream-segment-within-the-sub-catchment-with-the-same-unique-id">Snap point locations to the stream segment within the sub-catchment
with the same unique ID<a class="anchor" aria-label="anchor" href="#snap-point-locations-to-the-stream-segment-within-the-sub-catchment-with-the-same-unique-id"></a>
</h3>
<p>We will not use the <code>snap_to_subc_segment</code> in this example
and the code below is just to show the second option to snap point
locations to the stream network. Points snapped with this function will
always be located in the middle of the stream segment. For the
calculation the function needs the unique basin and sub- catchment IDs.
This can be done before by using the function <code>extract_ids</code>
or if the arguments subc_id and basin_id are set to NULL the
<code>snap_to_subc_segment</code> function will extract the IDs as
well.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># # Define full path to the GeoPackage of the stream segments</span></span>
<span><span class="co"># stream_vect &lt;- paste0(saofra_dir, "/order_vect_segment_481051.gpkg")</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#</span></span>
<span><span class="co"># # Note: The snapping of 138 points will takes about an hour</span></span>
<span><span class="co"># # Snap point locations to the stream segment within the sub-catchment the fish</span></span>
<span><span class="co"># # occurrence or dam site is located</span></span>
<span><span class="co"># point_data_snapped &lt;- snap_to_subc_segment(data = point_locations,</span></span>
<span><span class="co">#                                            lon = "longitude",</span></span>
<span><span class="co">#                                            lat = "latitude"",</span></span>
<span><span class="co">#                                            id = "site_id",</span></span>
<span><span class="co">#                                            basin_id = NULL,</span></span>
<span><span class="co">#                                            subc_id = NULL,</span></span>
<span><span class="co">#                                            basin_layer = basin_rast,</span></span>
<span><span class="co">#                                            subc_layer = subc_rast,</span></span>
<span><span class="co">#                                            stream_layer = stream_vect,</span></span>
<span><span class="co">#                                            n_cores = 3)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get-upstream-catchment">Get upstream catchment<a class="anchor" aria-label="anchor" href="#get-upstream-catchment"></a>
</h3>
<p>On the website of the <a href="https://www.iucnredlist.org/species/187028/1822039" class="external-link">IUCN red
list</a> we can see that the habitat range of <em>Conorhynchos
conirostris</em> is<br>
restricted to the areas upstream of the Sobradinho dam (site ID 2516)
and all our fish occurrence sites are located upstream of the dam as
well. Therefore, we are only interested in dams upstream of the
Sobradinho dam. To get the upstream catchment from the point location of
the Sobradinho dam we will use the function
<code>get_upstream_catchment</code>. Afterwards we will use the
<code>terra</code> package to polygonise the raster file of the upstream
catchment and use the polygon of the upstream catchment to filter our
point locations using the functions provided by the <code>sf</code>
package.</p>
<p><img src="../reference/figures/workflow5.png"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define full path for the direction raster layer</span></span>
<span><span class="va">direction_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">saofra_dir</span>, <span class="st">"/direction_481051.tif"</span><span class="op">)</span></span>
<span><span class="co"># Define full path for the output</span></span>
<span><span class="va">upcatch_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">saofra_dir</span>, <span class="st">"/upstream_catchment"</span><span class="op">)</span></span>
<span><span class="co"># Create output folder if it doesn't exist</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">upcatch_dir</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">upcatch_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the upstream catchment of ED 2516</span></span>
<span><span class="co"># Increasing the number of cores only makes sense if the calculation</span></span>
<span><span class="co"># is done for multiple points</span></span>
<span><span class="fu"><a href="../reference/get_upstream_catchment.html">get_upstream_catchment</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">point_locations_snapped</span><span class="op">)</span><span class="op">[</span><span class="va">site_id</span> <span class="op">==</span> <span class="fl">2516</span>,<span class="op">]</span>,</span>
<span>                       lon <span class="op">=</span> <span class="st">"lon_snap_accu"</span>,</span>
<span>                       lat <span class="op">=</span> <span class="st">"lat_snap_accu"</span>,</span>
<span>                       id <span class="op">=</span> <span class="st">"site_id"</span>,</span>
<span>                       direction_layer <span class="op">=</span> <span class="va">direction_rast</span>,</span>
<span>                       out_dir <span class="op">=</span> <span class="va">upcatch_dir</span>,</span>
<span>                       n_cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load raster file of the upstream catchment </span></span>
<span><span class="va">upstream_basin_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">upcatch_dir</span> , <span class="st">"/upstream_basin_2516.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Polygonise the raster</span></span>
<span><span class="va">upstream_basin_vect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.spatvector.html" class="external-link">as.polygons</a></span><span class="op">(</span><span class="va">upstream_basin_rast</span><span class="op">)</span></span>
<span><span class="co"># Save the vector file of the upstream catchment</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/writeVector.html" class="external-link">writeVector</a></span><span class="op">(</span><span class="va">upstream_basin_vect</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">upcatch_dir</span> , <span class="st">"/upstream_basin_2516.gpkg"</span><span class="op">)</span>, </span>
<span>            filetype <span class="op">=</span> <span class="st">"gpkg"</span>, overwrite<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">upstream_subc_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/crop_to_extent.html">crop_to_extent</a></span><span class="op">(</span>raster_layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">saofra_dir</span>,</span>
<span>                                                           <span class="st">"/sub_catchment_481051.tif"</span><span class="op">)</span>,</span>
<span>                                     vector_layer <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">upcatch_dir</span> ,</span>
<span>                                                            <span class="st">"/upstream_basin_2516.gpkg"</span><span class="op">)</span>,</span>
<span>                                     out_dir <span class="op">=</span> <span class="va">upcatch_dir</span>,</span>
<span>                                     file_name <span class="op">=</span>  <span class="st">"sub_catchment_2516.tif"</span>,</span>
<span>                                     read <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Get all sub-catchment IDs of the upstream basin</span></span>
<span><span class="va">subc_ids</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">upstream_subc_rast</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Filter the sub-catchment IDs from the GeoPackages of the order_vector_segment</span></span>
<span><span class="co"># basin file (sub-catchment ID = stream ID)</span></span>
<span><span class="va">upstream_segment_vect</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_geopackage.html">read_geopackage</a></span><span class="op">(</span>gpkg <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">saofra_dir</span>, </span>
<span>                                                <span class="st">"/order_vect_segment_481051.gpkg"</span><span class="op">)</span>,</span>
<span>                                        import_as <span class="op">=</span> <span class="st">"sf"</span>,</span>
<span>                                        subc_id <span class="op">=</span> <span class="va">subc_ids</span><span class="op">$</span><span class="va">sub_catchment_2516</span>,</span>
<span>                                        name <span class="op">=</span> <span class="st">"stream"</span><span class="op">)</span></span>
<span><span class="co"># Save the stream segments of the upstream drainage basin  </span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">write_sf</a></span><span class="op">(</span><span class="va">upstream_segment_vectt</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">upcatch_dir</span>, <span class="st">"/order_vect_segment_2516.gpkg"</span><span class="op">)</span><span class="op">)</span></span>
<span>                              </span>
<span></span>
<span><span class="co"># Convert the data.frame into a simply feature</span></span>
<span><span class="va">point_locations_snapped_pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">point_locations_snapped</span>,  </span>
<span>                                        coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon_snap_accu"</span>,<span class="st">"lat_snap_accu"</span><span class="op">)</span>, </span>
<span>                                        remove <span class="op">=</span> <span class="cn">FALSE</span>, crs<span class="op">=</span><span class="st">"WGS84"</span><span class="op">)</span></span>
<span><span class="co"># Save point locations as a GeoPackage</span></span>
<span><span class="co"># write_sf(point_locations_snapped_pts, paste0(upcatch_dir, "/point_locations_snapped_2516.gpkg"))</span></span>
<span></span>
<span><span class="co"># Use the polygon to filter the upstream point locations</span></span>
<span><span class="va">upstream_point_locations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_filter</a></span><span class="op">(</span><span class="va">point_locations_snapped_pts</span>, </span>
<span>                                      <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">upstream_basin_vect</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save upstream point locations</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fwrite.html" class="external-link">fwrite</a></span><span class="op">(</span><span class="va">upstream_point_locations</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">upcatch_dir</span>, <span class="st">"/upstream_point_locations_2516.csv"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the gpkg of the upstream basin (if not already loaded)</span></span>
<span><span class="co"># upstream_basin_vect &lt;- vect(paste0(upcatch_dir , "/upstream_basin_2516.gpkg"))</span></span>
<span></span>
<span><span class="co"># Create leaflet plot</span></span>
<span><span class="va">upcatch_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html" class="external-link">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/addProviderTiles.html" class="external-link">addProviderTiles</a></span><span class="op">(</span><span class="st">'Esri.WorldShadedRelief'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-methods.html" class="external-link">setMaxBounds</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">bbox</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html" class="external-link">addPolygons</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">upstream_basin_vect</span><span class="op">)</span> ,color <span class="op">=</span> <span class="st">"#444444"</span>, weight <span class="op">=</span> <span class="fl">1</span>, smoothFactor <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    opacity <span class="op">=</span> <span class="fl">1.0</span>, fillOpacity <span class="op">=</span> <span class="fl">0.5</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co">#addPolylines(data = stream_vect) %&gt;% </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html" class="external-link">addCircles</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">upstream_point_locations</span>, lng <span class="op">=</span> <span class="op">~</span><span class="va">lon_snap_accu</span>, </span>
<span>             lat <span class="op">=</span> <span class="op">~</span><span class="va">lat_snap_accu</span>, radius <span class="op">=</span> <span class="fl">0.2</span>, color <span class="op">=</span> <span class="op">~</span><span class="fu">pal</span><span class="op">(</span><span class="va">type</span><span class="op">)</span>,</span>
<span>              opacity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/addLegend.html" class="external-link">addLegend</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">upstream_point_locations</span>, pal <span class="op">=</span> <span class="va">pal</span>, values <span class="op">=</span> <span class="op">~</span><span class="va">type</span>,</span>
<span>            labFormat <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">type</span>, <span class="va">cuts</span>, <span class="va">p</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span><span class="op">}</span>,</span>
<span>            title <span class="op">=</span> <span class="st">"Site type"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">upcatch_plot</span></span></code></pre></div>
<p><img src="../reference/figures/upstream_catchment.png"></p>
</div>
<div class="section level3">
<h3 id="get-distance-along-the-stream-network">Get distance along the stream network<a class="anchor" aria-label="anchor" href="#get-distance-along-the-stream-network"></a>
</h3>
<p>To determine the distance to the closest dam up- and downstream of
each fish occurrence site we will first calculate the distance between
all point locations using the function <code>get_distance</code>.</p>
<p><img src="../reference/figures/workflow6.png"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load layers (if not already loaded)</span></span>
<span><span class="co"># upstream_basin_rast &lt;- paste0(upcatch_dir, "/upstream_basin_2516.tif")</span></span>
<span><span class="co"># upstream_segment_vect &lt;- paste0(upcatch_dir, "/order_vect_segment_2516.gpkg")</span></span>
<span></span>
<span><span class="co"># Get the distances along the stream network between each pair of point locations</span></span>
<span><span class="co"># The process takes about 1 hour </span></span>
<span><span class="co"># Increasing the number of cores only makes sense if the calculation</span></span>
<span><span class="co"># is done for points in multiple drainage basins</span></span>
<span><span class="va">upstream_point_locations</span> <span class="op">&lt;-</span> <span class="va">upstream_point_locations</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>basin_id <span class="op">=</span> <span class="fl">2516</span><span class="op">)</span></span>
<span></span>
<span><span class="va">network_distance</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_distance.html">get_distance</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">upstream_point_locations</span>,</span>
<span>                                 lon <span class="op">=</span> <span class="st">"lon_snap_accu"</span>,</span>
<span>                                 lat <span class="op">=</span> <span class="st">"lat_snap_accu"</span>,</span>
<span>                                 id <span class="op">=</span> <span class="st">"site_id"</span>,</span>
<span>                                 basin_id <span class="op">=</span> <span class="st">"basin_id"</span>,</span>
<span>                                 basin_layer <span class="op">=</span> <span class="va">upstream_basin_rast</span>,</span>
<span>                                 stream_layer <span class="op">=</span> <span class="va">upstream_segment_vect</span>,</span>
<span>                                 distance <span class="op">=</span> <span class="st">"network"</span>,</span>
<span>                                 n_cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:200px; overflow-x: scroll; width:700px; ">
<table class="table table table-striped" style="width: auto !important; ">
<thead><tr>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
from_site_id
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
to_site_id
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
dist
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
2373
</td>
<td style="text-align:right;">
2375
</td>
<td style="text-align:right;">
822666
</td>
</tr>
<tr>
<td style="text-align:right;">
2373
</td>
<td style="text-align:right;">
2396
</td>
<td style="text-align:right;">
1564589
</td>
</tr>
<tr>
<td style="text-align:right;">
2373
</td>
<td style="text-align:right;">
2516
</td>
<td style="text-align:right;">
1768802
</td>
</tr>
<tr>
<td style="text-align:right;">
2373
</td>
<td style="text-align:right;">
2521
</td>
<td style="text-align:right;">
1752916
</td>
</tr>
<tr>
<td style="text-align:right;">
2373
</td>
<td style="text-align:right;">
2530
</td>
<td style="text-align:right;">
1201006
</td>
</tr>
<tr>
<td style="text-align:right;">
2373
</td>
<td style="text-align:right;">
2531
</td>
<td style="text-align:right;">
1067073
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level3">
<h3 id="get-catchment-graph">Get catchment graph<a class="anchor" aria-label="anchor" href="#get-catchment-graph"></a>
</h3>
<p>To evaluate which and how many dames are located up- and downstream
of the fish occurrence sites, we need to load the GeoPackage of the
stream segments ( order_vect_segment) as a graph. Further we will need
the sub-catchment IDs of the fish occurrence sites to use the function
<code>get_catchment_graph</code>. The function will return for each fish
occurrence site all sub-catchment IDs which are located up- or
downstream.</p>
<p><img src="../reference/figures/workflow7.png"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define full path to the GeoPackage of the stream segments</span></span>
<span><span class="co"># upstream_segment_vect &lt;- paste0(upcatch_dir, "/order_vect_segment_2516.gpkg")</span></span>
<span></span>
<span><span class="co"># Load the GeoPackage as graph</span></span>
<span><span class="va">stream_network_graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_geopackage.html">read_geopackage</a></span><span class="op">(</span>gpkg <span class="op">=</span> <span class="va">upstream_segment_vect</span>, import_as <span class="op">=</span> <span class="st">"graph"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get sub-catchment IDs of the fish occurrence sites</span></span>
<span><span class="va">fs_subc_ids</span> <span class="op">&lt;-</span> <span class="va">upstream_point_locations</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>subcatchment_id <span class="op">=</span> <span class="va">subc_id_snap_accu</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">site_id</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="va">.</span><span class="op">$</span><span class="va">subcatchment_id</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get all stream segment IDs (=sub-catchments IDs)  upstream for each</span></span>
<span><span class="co"># fish occurrence site</span></span>
<span><span class="co"># Note: There will be no output for fish occurrence sites which are located</span></span>
<span><span class="co"># in headwaters (Strahler order 1)</span></span>
<span><span class="va">upstream_segments</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_catchment_graph.html">get_catchment_graph</a></span><span class="op">(</span>g <span class="op">=</span> <span class="va">stream_network_graph</span>,</span>
<span>                                         subc_id <span class="op">=</span> <span class="va">fs_subc_ids</span>, mode <span class="op">=</span> <span class="st">"in"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get all stream segment IDs downstream for each</span></span>
<span><span class="co"># fish occurrence site</span></span>
<span><span class="co"># Note: There will be no output for fish occurrence sites which are located</span></span>
<span><span class="co"># in the last segments before the outlet</span></span>
<span><span class="va">downstream_segments</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_catchment_graph.html">get_catchment_graph</a></span><span class="op">(</span>g <span class="op">=</span> <span class="va">stream_network_graph</span>,</span>
<span>                                           subc_id <span class="op">=</span> <span class="va">fs_subc_ids</span>, mode <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span></span></code></pre></div>
<p>Here the head of an example data.frame of one fish occurrence site
(sub-catchment ID 168036446).</p>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:200px; overflow-x: scroll; width:700px; ">
<table class="table table table-striped" style="width: auto !important; ">
<thead><tr>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
stream
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
next_stream
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
prev_str01
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
prev_str02
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
prev_str03
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
prev_str04
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
strahler
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
horton
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
168312446
</td>
<td style="text-align:right;">
168313029
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
168312604
</td>
<td style="text-align:right;">
168313165
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
168310758
</td>
<td style="text-align:right;">
168310607
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
168310759
</td>
<td style="text-align:right;">
168310307
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
168310447
</td>
<td style="text-align:right;">
168310448
</td>
<td style="text-align:right;">
168309541
</td>
<td style="text-align:right;">
168310757
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:right;">
168310308
</td>
<td style="text-align:right;">
168310008
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level3">
<h3 id="determine-the-number-of-dams-and-the-distance-alonge-the-network-to-the-closest-dam">Determine the number of dams and the distance alonge the network to
the closest dam<a class="anchor" aria-label="anchor" href="#determine-the-number-of-dams-and-the-distance-alonge-the-network-to-the-closest-dam"></a>
</h3>
<p>After we have determined the distance between the point locations and
now the sub-catchment IDs up- and downstream of each fish occurrence
site we can estimate the number of dams and evaluate the distance to the
closest dam.</p>
<p><img src="../reference/figures/workflow.png"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get all sub-catchment IDs of fish occurrence sites with stream </span></span>
<span><span class="co"># segments upstream</span></span>
<span><span class="va">fs_subc_ids_up</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">upstream_segments</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get site IDs of the fish occurrence sites </span></span>
<span><span class="va">fs_site_id</span> <span class="op">&lt;-</span> <span class="va">upstream_point_locations</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">subc_id_snap_accu</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="va">fs_subc_ids_up</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">subc_id_snap_accu</span>, <span class="va">fs_subc_ids_up</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>from_site_id <span class="op">=</span> <span class="va">site_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the sub-catchment IDs where the existing dams are located</span></span>
<span><span class="va">ed_site_id</span> <span class="op">&lt;-</span> <span class="va">upstream_point_locations</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"ED"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>stream <span class="op">=</span>  <span class="va">subc_id_snap_accu</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>stream <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">stream</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the number of existing dams upstream and the distance to the closest</span></span>
<span><span class="co"># dam upstream</span></span>
<span><span class="va">ed_upstream</span> <span class="op">&lt;-</span> <span class="va">upstream_segments</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">ed_site_id</span>, <span class="va">.x</span>, by<span class="op">=</span> <span class="st">"stream"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">fs_site_id</span><span class="op">$</span><span class="va">from_site_id</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">.x</span>, from_site_id <span class="op">=</span> <span class="va">.y</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="va">.</span>, to_site_id <span class="op">=</span> <span class="va">site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">from_site_id</span>, <span class="va">to_site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">network_distance</span>, <span class="va">.</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"from_site_id"</span>, <span class="st">"to_site_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">from_site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">.</span>, n_dams <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">dist</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">fs_site_id</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"from_site_id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"ED"</span>,</span>
<span>         direction <span class="op">=</span> <span class="st">"upstream"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the sub-catchment IDs where the future dams will be located</span></span>
<span><span class="va">fd_site_id</span> <span class="op">&lt;-</span> <span class="va">upstream_point_locations</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">site_id</span> <span class="op">&gt;</span> <span class="fl">100</span> <span class="op">&amp;</span> <span class="va">site_id</span> <span class="op">&lt;</span> <span class="fl">2000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>stream <span class="op">=</span>  <span class="va">subc_id_snap_accu</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>stream <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">stream</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">.</span>,<span class="va">point_locations</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site_id"</span>, <span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the number of future dams upstream and the distance to the closest</span></span>
<span><span class="co"># dam upstream</span></span>
<span><span class="va">fd_upstream</span> <span class="op">&lt;-</span> <span class="va">upstream_segments</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">fd_site_id</span>, <span class="va">.x</span>, by<span class="op">=</span> <span class="st">"stream"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">fs_site_id</span><span class="op">$</span><span class="va">from_site_id</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">.x</span>, from_site_id <span class="op">=</span> <span class="va">.y</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="va">.</span>, to_site_id <span class="op">=</span> <span class="va">site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">from_site_id</span>, <span class="va">to_site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">network_distance</span>, <span class="va">.</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"from_site_id"</span>, <span class="st">"to_site_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">from_site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">.</span>, n_dams <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">dist</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">fs_site_id</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"from_site_id"</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"FD"</span>,</span>
<span>         direction <span class="op">=</span> <span class="st">"upstream"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get all sub-catchment IDs of fish occurrence sites with stream </span></span>
<span><span class="co"># segments downstream</span></span>
<span><span class="va">fs_subc_ids_down</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">downstream_segments</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get unique site IDs of the fish occurrence sites </span></span>
<span><span class="va">fs_site_id</span> <span class="op">&lt;-</span> <span class="va">upstream_point_locations</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">subc_id_snap_accu</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="va">fs_subc_ids_down</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">subc_id_snap_accu</span>, <span class="va">fs_subc_ids_down</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>from_site_id <span class="op">=</span> <span class="va">site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">from_site_id</span> <span class="op">!=</span> <span class="fl">14</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Get the number of existing dams downstream and the distance to the closest</span></span>
<span><span class="co"># dam downstream</span></span>
<span><span class="va">ed_downstream</span> <span class="op">&lt;-</span> <span class="va">downstream_segments</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">ed_site_id</span>, <span class="va">.x</span>, by<span class="op">=</span> <span class="st">"stream"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">fs_site_id</span><span class="op">$</span><span class="va">from_site_id</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">.x</span>, from_site_id <span class="op">=</span> <span class="va">.y</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="va">.</span>, to_site_id <span class="op">=</span> <span class="va">site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">from_site_id</span>, <span class="va">to_site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">network_distance</span>, <span class="va">.</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"from_site_id"</span>, <span class="st">"to_site_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">from_site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">.</span>, n_dams <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">dist</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">fs_site_id</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"from_site_id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"ED"</span>,</span>
<span>         direction <span class="op">=</span> <span class="st">"downstream"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the number of future dams downstream and the distance to the closest</span></span>
<span><span class="co"># dam downstream</span></span>
<span><span class="va">fd_downstream</span> <span class="op">&lt;-</span> <span class="va">downstream_segments</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">fd_site_id</span>, <span class="va">.x</span>, by<span class="op">=</span> <span class="st">"stream"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">fs_site_id</span><span class="op">$</span><span class="va">from_site_id</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">.x</span>, from_site_id <span class="op">=</span> <span class="va">.y</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="va">.</span>, to_site_id <span class="op">=</span> <span class="va">site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">from_site_id</span>, <span class="va">to_site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">network_distance</span>, <span class="va">.</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"from_site_id"</span>, <span class="st">"to_site_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">from_site_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">.</span>, n_dams <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">dist</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">fs_site_id</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"from_site_id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"FD"</span>,</span>
<span>         direction <span class="op">=</span> <span class="st">"downstream"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bind tables</span></span>
<span><span class="va">dam_num_dist</span> <span class="op">&lt;-</span> <span class="va">ed_upstream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">fd_upstream</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">ed_downstream</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">fd_downstream</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data.frame for the plot</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">dam_num_dist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="va">dist</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">direction</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"upstream"</span>, <span class="st">"downstream"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define colors</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>ED <span class="op">=</span> <span class="st">"#E69F00"</span>, FD <span class="op">=</span> <span class="st">"#56B4E9"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create plot to show the number of dams</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/is.bool.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">from_site_id</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">n_dams</span>, fill <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html" class="external-link">fct_rev</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span>, position<span class="op">=</span> <span class="st">"stack"</span>, width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="op">~</span> <span class="va">direction</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Dams"</span>,</span>
<span>                      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ED"</span>, <span class="st">"FD"</span><span class="op">)</span>,</span>
<span>                      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Existing"</span>, <span class="st">"Future"</span><span class="op">)</span>,</span>
<span>                      values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fish occurrence site ID"</span>, y <span class="op">=</span> <span class="st">"Number of dams"</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/number_of_dams.png"></p>
<p>With the exception of the fish occurrence sites 4 and 6 the number of
upstream dams will dramatically increase. Especially for site 9, which
has already 14 dams located upstream, the number might increase in the
future to 94 dams. Downstream of all fish occurrence sites there is
currently only one existing dam. It is the dam with the ID 2516 at the
outlet of our delineated upstream catchment. This leads to the
assumption that all fish occurrence sites are currently connected. In
the future the number of dams will increase for the fish occurrence
sites 7 and 8 from one to two dames. The future dam might lead to a
disconnection of these two sites from the others.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create plot to show the distance to the closest dam</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/is.bool.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">from_site_id</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">dist</span>, fill <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span>, position<span class="op">=</span> <span class="st">"dodge"</span>, width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="op">~</span> <span class="va">direction</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Dams"</span>,</span>
<span>                      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ED"</span>, <span class="st">"FD"</span><span class="op">)</span>,</span>
<span>                      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Existing"</span>, <span class="st">"Future"</span><span class="op">)</span>,</span>
<span>                      values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fish occurrence site ID"</span>, y <span class="op">=</span> <span class="st">"Distance along the stream network (km)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/distance_to_dams.png"></p>
<p>The distance to the next existing dam upstream ranges from 12.6km for
the fish occurrence site 8 to 528.9km for the fish occurrence site 9.
For most sites the the distance to the next dam upstream will decrease
in the future. Only for the fish occurrence sites 7 and 8 the next
future dam upstream will farther away than the existing dam. The
distance to the existing dam downstream ranges between 415.2km and
1672.0km. In the future the distance for the next dam downstream will
decrease from about 1475km to about 114km for the fish occurrence sites
7 and 8.</p>
</div>
<div class="section level3 unnumbered">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-amatulli2022hydrography90m" class="csl-entry">
Amatulli, Giuseppe, Jaime Garcia Marquez, Tushar Sethi, Jens Kiesel,
Afroditi Grigoropoulou, Maria M Üblacker, Longzhu Q Shen, and Sami
Domisch. 2022. <span>“Hydrography90m: A New High-Resolution Global
Hydrographic Dataset.”</span> <em>Earth System Science Data</em> 14
(10): 4525–50.
</div>
<div id="ref-R-leafem" class="csl-entry">
Appelhans, Tim. 2022. <em>Leafem: Leaflet Extensions for Mapview</em>.
<a href="https://CRAN.R-project.org/package=leafem" class="external-link">https://CRAN.R-project.org/package=leafem</a>.
</div>
<div id="ref-R-mapview" class="csl-entry">
Appelhans, Tim, Florian Detsch, Christoph Reudenbach, and Stefan
Woellauer. 2022. <em>Mapview: Interactive Viewing of Spatial Data in
r</em>. <a href="https://github.com/r-spatial/mapview" class="external-link">https://github.com/r-spatial/mapview</a>.
</div>
<div id="ref-gbif" class="csl-entry">
Chamberlain S., Boettiger C. 2017. <span>““R Python, and Ruby Clients
for GBIF Species Occurrencedata.”</span> <em>PeerJ Preprints
5:e3304v1</em>.
</div>
<div id="ref-R-rgbif" class="csl-entry">
Chamberlain S., Mcglinn D., Barve V. 2023. <em>Rgbif: Interface to the
Global Biodiversity Information Facility API</em>. <a href="https://CRAN.R-project.org/package=rgbif" class="external-link">https://CRAN.R-project.org/package=rgbif</a>.
</div>
<div id="ref-R-leaflet" class="csl-entry">
Cheng, Joe, Barret Schloerke, Bhaskar Karambelkar, and Yihui Xie. 2023.
<em>Leaflet: Create Interactive Web Maps with the JavaScript Leaflet
Library</em>. <a href="https://rstudio.github.io/leaflet/" class="external-link">https://rstudio.github.io/leaflet/</a>.
</div>
<div id="ref-R-data.table" class="csl-entry">
Dowle, Matt, and Arun Srinivasan. 2022. <em>Data.table: Extension of
‘Data.frame‘</em>. <a href="https://CRAN.R-project.org/package=data.table" class="external-link">https://CRAN.R-project.org/package=data.table</a>.
</div>
<div id="ref-R-terra" class="csl-entry">
Hijmans, Robert J. 2023. <em>Terra: Spatial Data Analysis</em>. <a href="https://rspatial.org/terra/" class="external-link">https://rspatial.org/terra/</a>.
</div>
<div id="ref-R-sf" class="csl-entry">
Pebesma, Edzer. 2018. <span>“<span class="nocase">Simple Features for R:
Standardized Support for Spatial Vector Data</span>.”</span>
<em><span>The R Journal</span></em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009" class="external-link">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
<div id="ref-R-base" class="csl-entry">
R Core Team. 2022. <em>R: A Language and Environment for Statistical
Computing</em>. Vienna, Austria: R Foundation for Statistical Computing.
<a href="https://www.R-project.org/" class="external-link">https://www.R-project.org/</a>.
</div>
<div id="ref-R-hydrographr" class="csl-entry">
Üblacker, Maria, Afroditi Grigoropoulou, Jaime Garcia Marquez, Yusdiel
Torres Cambas, Christoph Schürz, Mathieu Floury, Thomas Tomiczek,
Vanessa Bremerich, Giuseppe Amatulli, and Sami Domisch. 2023.
<em>Hydrographr: Scalable Hydrographic Data Processing in r</em>. <a href="https://glowabio.github.io/hydrographr/" class="external-link">https://glowabio.github.io/hydrographr/</a>.
</div>
<div id="ref-R-htmlwidgets" class="csl-entry">
Vaidyanathan, Ramnath, Yihui Xie, JJ Allaire, Joe Cheng, Carson Sievert,
and Kenton Russell. 2023. <em>Htmlwidgets: HTML Widgets for r</em>. <a href="https://github.com/ramnathv/htmlwidgets" class="external-link">https://github.com/ramnathv/htmlwidgets</a>.
</div>
<div id="ref-R-ggplot2" class="csl-entry">
Wickham, Hadley. 2016. <em>Ggplot2: Elegant Graphics for Data
Analysis</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org" class="external-link">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-R-stringr" class="csl-entry">
———. 2022. <em>Stringr: Simple, Consistent Wrappers for Common String
Operations</em>. <a href="https://CRAN.R-project.org/package=stringr" class="external-link">https://CRAN.R-project.org/package=stringr</a>.
</div>
<div id="ref-R-forcats" class="csl-entry">
———. 2023. <em>Forcats: Tools for Working with Categorical Variables
(Factors)</em>. <a href="https://CRAN.R-project.org/package=forcats" class="external-link">https://CRAN.R-project.org/package=forcats</a>.
</div>
<div id="ref-R-dplyr" class="csl-entry">
Wickham, Hadley, Romain François, Lionel Henry, and Kirill Müller. 2022.
<em>Dplyr: A Grammar of Data Manipulation</em>. <a href="https://CRAN.R-project.org/package=dplyr" class="external-link">https://CRAN.R-project.org/package=dplyr</a>.
</div>
<div id="ref-R-purrr" class="csl-entry">
Wickham, Hadley, and Lionel Henry. 2023. <em>Purrr: Functional
Programming Tools</em>. <a href="https://CRAN.R-project.org/package=purrr" class="external-link">https://CRAN.R-project.org/package=purrr</a>.
</div>
<div id="ref-knitr2014" class="csl-entry">
Xie, Yihui. 2014. <span>“Knitr: A Comprehensive Tool for Reproducible
Research in <span>R</span>.”</span> In <em>Implementing Reproducible
Computational Research</em>, edited by Victoria Stodden, Friedrich
Leisch, and Roger D. Peng. Chapman; Hall/CRC.
</div>
<div id="ref-knitr2015" class="csl-entry">
———. 2015. <em>Dynamic Documents with <span>R</span> and Knitr</em>. 2nd
ed. Boca Raton, Florida: Chapman; Hall/CRC. <a href="https://yihui.org/knitr/" class="external-link">https://yihui.org/knitr/</a>.
</div>
<div id="ref-R-knitr" class="csl-entry">
———. 2023. <em>Knitr: A General-Purpose Package for Dynamic Report
Generation in r</em>. <a href="https://yihui.org/knitr/" class="external-link">https://yihui.org/knitr/</a>.
</div>
<div id="ref-R-kableExtra" class="csl-entry">
Zhu, Hao. 2021. <em>kableExtra: Construct Complex Table with Kable and
Pipe Syntax</em>. <a href="https://CRAN.R-project.org/package=kableExtra" class="external-link">https://CRAN.R-project.org/package=kableExtra</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Maria Üblacker, Afroditi Grigoropoulou, Jaime Garcia Marquez, Yusdiel Torres Cambas, Christoph Schürz, Mathieu Floury, Thomas Tomiczek, Vanessa Bremerich, Giuseppe Amatulli, Sami Domisch.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
