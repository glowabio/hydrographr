<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Calculate upstream variables for each sub-catchment — get_upstream_variable • hydrographr</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calculate upstream variables for each sub-catchment — get_upstream_variable"><meta name="description" content='For each input sub-catchment, the function calculates the
upstream mean, median, min, max, sd or sum for one or more variables. Note
that the stream segment and sub-catchment IDs are identical. The input
graph can be created with read_geopackage()
and get_catchment_graph().
This function can be used to obtain all upstream stream segments /
sub-catchments for species distribution modelling, or for spatial
prioritization analyses (e.g. Marxan/Gurobi) to specify the connectivity
(and in this case the "length" attribute can be used).
The function accepts as an input a graph with one ore more outlets (e.g.
an entire tile with many drainage basins). The variable that should be
aggregated upstream should be prepared as a data.table, e.g.
with extract_zonal_stat().'><meta property="og:description" content='For each input sub-catchment, the function calculates the
upstream mean, median, min, max, sd or sum for one or more variables. Note
that the stream segment and sub-catchment IDs are identical. The input
graph can be created with read_geopackage()
and get_catchment_graph().
This function can be used to obtain all upstream stream segments /
sub-catchments for species distribution modelling, or for spatial
prioritization analyses (e.g. Marxan/Gurobi) to specify the connectivity
(and in this case the "length" attribute can be used).
The function accepts as an input a graph with one ore more outlets (e.g.
an entire tile with many drainage basins). The variable that should be
aggregated upstream should be prepared as a data.table, e.g.
with extract_zonal_stat().'></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hydrographr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/hydrographr.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/benchmark.html">Function benchmarks</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_brazil.html">Case study - São Francisco drainage basin</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_cuba.html">Case study - Cuba</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_Danube.html">Case study - Danube Basin (Environment90m)</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_germany.html">Case study - Germany</a></li>
    <li><a class="dropdown-item" href="../articles/case_study_lakes.html">Case study - Lake Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/example_other_stream_networks.html">Usage of hydrographr with other stream networks</a></li>
    <li><a class="dropdown-item" href="../articles/linux_system_setup.html">Setting up the package requirements on Linux</a></li>
    <li><a class="dropdown-item" href="../articles/macos_system_setup.html">Setting up the package requirements on MacOS</a></li>
    <li><a class="dropdown-item" href="../articles/windows_system_setup.html">Setting up the package requirements on Windows</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/glowabio/hydrographr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Calculate upstream variables for each sub-catchment</h1>
      <small class="dont-index">Source: <a href="https://github.com/glowabio/hydrographr/blob/HEAD/R/get_upstream_variable.R" class="external-link"><code>R/get_upstream_variable.R</code></a></small>
      <div class="d-none name"><code>get_upstream_variable.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>For each input sub-catchment, the function calculates the
upstream mean, median, min, max, sd or sum for one or more variables. Note
that the stream segment and sub-catchment IDs are identical. The input
graph can be created with <code><a href="read_geopackage.html">read_geopackage()</a></code>
and <code><a href="get_catchment_graph.html">get_catchment_graph()</a></code>.</p>
<p>This function can be used to obtain all upstream stream segments /
sub-catchments for species distribution modelling, or for spatial
prioritization analyses (e.g. Marxan/Gurobi) to specify the connectivity
(and in this case the "length" attribute can be used).</p>
<p>The function accepts as an input a graph with one ore more outlets (e.g.
an entire tile with many drainage basins). The variable that should be
aggregated upstream should be prepared as a data.table, e.g.
with <code><a href="extract_zonal_stat.html">extract_zonal_stat()</a></code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">get_upstream_variable</span><span class="op">(</span></span>
<span>  <span class="va">g</span>,</span>
<span>  variable_table <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  subc_id <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  var_layer <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  upstream_stat <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  include_focal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  save_up_conn <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  load_up_conn <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  n_cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  max_size <span class="op">=</span> <span class="fl">3000</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-g">g<a class="anchor" aria-label="anchor" href="#arg-g"></a></dt>
<dd><p>igraph object. A directed graph.</p></dd>


<dt id="arg-variable-table">variable_table<a class="anchor" aria-label="anchor" href="#arg-variable-table"></a></dt>
<dd><p>a data.table that includes the <code>stream</code> column
(corresponding to the subc_id) as well as the attributes that should be
aggregated across the the upstream network subc_id. Default is NULL.</p></dd>


<dt id="arg-subc-id">subc_id<a class="anchor" aria-label="anchor" href="#arg-subc-id"></a></dt>
<dd><p>A vector of subc_id for which the upstream variables should
be calculated. Optional; default is to use all subc_id of the input graph.</p></dd>


<dt id="arg-var-layer">var_layer<a class="anchor" aria-label="anchor" href="#arg-var-layer"></a></dt>
<dd><p>character vector. One or more attributes (variable layers)
of the variable_table should be reported for each output subc_id.
Default is NULL.</p></dd>


<dt id="arg-upstream-stat">upstream_stat<a class="anchor" aria-label="anchor" href="#arg-upstream-stat"></a></dt>
<dd><p>one of the functions mean, median, min, max, sd, sum
(without quotes). The function will be used to aggregate (or summarize)
the upstream variables for each subc_id (e.g., the average
land cover across the entire upstream area). Default is NULL.</p></dd>


<dt id="arg-include-focal">include_focal<a class="anchor" aria-label="anchor" href="#arg-include-focal"></a></dt>
<dd><p>Whether the focal subc_id should be
included in the aggregation with <code>include_focal = TRUE</code> which is the
default. Set to FALSE if the focal subc_id should not be included in the
upstream aggregation of the given sub-catchment.</p></dd>


<dt id="arg-save-up-conn">save_up_conn<a class="anchor" aria-label="anchor" href="#arg-save-up-conn"></a></dt>
<dd><p>character. Provide a name of the .RData file that will be
written to disk (to <code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd()</a></code>), and which includes the intermediate result
consisting of a data.table that includes all upstream connections for each
subc_id. Useful for large study areas as it avoids re-running
the possibly time-consuming pre-processing to obtain other metrics (e.g.
mean, sum) or other variables. The data.table is called <code>upstream_dt</code>
and has the columns <code>stream</code> and <code>base</code>. Default is FALSE.</p></dd>


<dt id="arg-load-up-conn">load_up_conn<a class="anchor" aria-label="anchor" href="#arg-load-up-conn"></a></dt>
<dd><p>Optional, and if used, it should be <code>upstream_dt</code>.
In case the file with the upstream connections was previously written to
disk (using e.g. <code>save_up_conn = "my_file"</code>), then this data.table can
be first loaded with <code>load(paste0(getwd(), "/my_file.RData"))</code>, which
loads the <code>upstream_dt</code> data.table with the columns
<code>c("stream", "base")</code>. Use  <code>load_up_conn = upstream_dt</code> to then
skip the pre-processing. Optional, default is NULL.</p></dd>


<dt id="arg-n-cores">n_cores<a class="anchor" aria-label="anchor" href="#arg-n-cores"></a></dt>
<dd><p>numeric. Number of cores used for parallelisation. In case
the graph is very large, and many segments are used as an input, setting
n_cores to a higher value can speed up the computation. Note however that
the parallelisation process requires copying the input graph to each core.
This may result in possible RAM limitations and even slower processing.
Hence consider testing first with a lower number of cores. Default is
n_cores = 1. Optional.</p></dd>


<dt id="arg-max-size">max_size<a class="anchor" aria-label="anchor" href="#arg-max-size"></a></dt>
<dd><p>numeric. Specifies the maximum size of the data passed to the
parallel back-end in MB. Default is 1500 (1.5 GB). Consider a higher value
for large study areas (more than one 20°x20° tile). Optional.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A data.table indicating the "stream" (=subc_id) and the upstream variables
which have the same column names as the <code>var_layer</code> argument. The
intermediate output can be saved to disk (requires setting
<code>save_up_conn</code> = "my_file").</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Csardi G, Nepusz T: The igraph software package for complex network research,
InterJournal, Complex Systems 1695. 2006. <a href="https://igraph.org" class="external-link">https://igraph.org</a></p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="read_geopackage.html">read_geopackage()</a></code> and <code><a href="get_catchment_graph.html">get_catchment_graph()</a></code> to
create the input graph. Alternatively, see
<code><a href="get_segment_neighbours.html">get_segment_neighbours()</a></code> to obtain the upstream variables for
a specified neighbourhood.</p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Sami Domisch</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># Download test data into the temporary R folder</span></span>
<span><span class="co"># or define a different directory</span></span>
<span><span class="va">my_directory</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">my_directory</span><span class="op">)</span></span>
<span><span class="fu"><a href="download_test_data.html">download_test_data</a></span><span class="op">(</span><span class="va">my_directory</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the stream network as graph</span></span>
<span><span class="va">my_graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="read_geopackage.html">read_geopackage</a></span><span class="op">(</span>gpkg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my_directory</span>,</span>
<span>                                         <span class="st">"/hydrography90m_test_data"</span>,</span>
<span>                                         <span class="st">"/order_vect_59.gpkg"</span><span class="op">)</span>,</span>
<span>                                          import_as <span class="op">=</span> <span class="st">"graph"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subset the graph and get a smaller catchment</span></span>
<span><span class="va">my_graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="get_catchment_graph.html">get_catchment_graph</a></span><span class="op">(</span>g <span class="op">=</span> <span class="va">my_graph</span>,</span>
<span>                                subc_id <span class="op">=</span> <span class="fl">513867228</span>,</span>
<span>                                mode <span class="op">=</span> <span class="st">"in"</span>,</span>
<span>                                use_outlet <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                as_graph <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                n_cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Prepare the variables that should be accumulated.</span></span>
<span><span class="co">## Load the table</span></span>
<span><span class="va">variable_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="read_geopackage.html">read_geopackage</a></span><span class="op">(</span>gpkg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my_directory</span>,</span>
<span>                                               <span class="st">"/hydrography90m_test_data"</span>,</span>
<span>                                              <span class="st">"/order_vect_59.gpkg"</span><span class="op">)</span>,</span>
<span>                                              import_as <span class="op">=</span> <span class="st">"data.table"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Specify the layers for the upstream aggregation</span></span>
<span><span class="va">var_layer</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"length"</span>, <span class="st">"flow_accum"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Subset the table</span></span>
<span><span class="va">keep_these</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"stream"</span>, <span class="va">var_layer</span><span class="op">)</span></span>
<span><span class="va">variable_table</span> <span class="op">&lt;-</span> <span class="va">variable_table</span><span class="op">[</span>, <span class="va">..keep_these</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="co">## Get the upstream sum of the variables "length" and "flow_accum" for</span></span>
<span><span class="co">## single subc_id</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">get_upstream_variable</span><span class="op">(</span><span class="va">my_graph</span>,</span>
<span>                                variable_table <span class="op">=</span> <span class="va">variable_table</span>,</span>
<span>                                var_layer <span class="op">=</span> <span class="va">var_layer</span>,</span>
<span>                                upstream_stat<span class="op">=</span><span class="va">sum</span>,</span>
<span>                                subc_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">513861908</span>, <span class="fl">513864129</span><span class="op">)</span>,</span>
<span>                                include_focal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Get the upstream sum of the variables "length" and "flow_accum" across the</span></span>
<span><span class="co">## entire network</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">get_upstream_variable</span><span class="op">(</span><span class="va">my_graph</span>,</span>
<span>                                variable_table <span class="op">=</span> <span class="va">variable_table</span>,</span>
<span>                                var_layer <span class="op">=</span> <span class="va">var_layer</span>,</span>
<span>                                upstream_stat<span class="op">=</span><span class="va">sum</span>,</span>
<span>                                include_focal <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                n_cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                save_up_conn <span class="op">=</span> <span class="st">"my_file"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Alternatively, load the previously generated upstream connections</span></span>
<span><span class="co">## and use it directly, skipping the pre-processing</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/my_file.RData"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">get_upstream_variable</span><span class="op">(</span><span class="va">my_graph</span>,</span>
<span>                                variable_table <span class="op">=</span> <span class="va">variable_table</span>,</span>
<span>                                var_layer <span class="op">=</span> <span class="va">var_layer</span>,</span>
<span>                                upstream_stat<span class="op">=</span><span class="va">max</span>,</span>
<span>                                include_focal <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                load_up_conn <span class="op">=</span> <span class="va">upstream_dt</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co">## Map the new variable across the network</span></span>
<span></span>
<span><span class="co">## Specify tif-layer for reclassification</span></span>
<span><span class="va">subc_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my_directory</span>, <span class="st">"/hydrography90m_test_data/subcatchment_1264942.tif"</span><span class="op">)</span></span>
<span><span class="va">recl_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my_directory</span>, <span class="st">"/upstream_sum.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Set columns as integer</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">as.integer</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">### Create raster - select the "to" column which represents the unique subc_id</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="reclass_raster.html">reclass_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">result</span>,</span>
<span>                   rast_val <span class="op">=</span> <span class="st">"stream"</span>,</span>
<span>                   new_val <span class="op">=</span> <span class="st">"flow_accum"</span>,</span>
<span>                   raster_layer <span class="op">=</span> <span class="va">subc_raster</span>,</span>
<span>                   recl_layer <span class="op">=</span> <span class="va">recl_raster</span>,</span>
<span>                   read <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Plot the map</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r</span>, background <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span>
<span></span>
<span></span></code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Marlene Schürz, Afroditi Grigoropoulou, Jaime Garcia Marquez, Yusdiel Torres Cambas, Christoph Schürz, Mathieu Floury, Thomas Tomiczek, Vanessa Bremerich, Merret Buurman, Giuseppe Amatulli, Sami Domisch.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

